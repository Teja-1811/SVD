{% extends 'customer_portal/base.html' %}
{% load static %}

{% block title %}Place Order - Customer Portal{% endblock %}

{% block extra_css %}
<style>

/* ------------------------------------------------------------
   GLOBAL
------------------------------------------------------------ */
.page-title {
    font-weight: 600;
    margin-bottom: 20px;
}
.card { border-radius: 12px; }

/* ------------------------------------------------------------
   COMPANY TABS (scrollable)
------------------------------------------------------------ */
.company-tabs {
    display: flex;
    overflow-x: auto;
    white-space: nowrap;
    flex-wrap: nowrap !important;
    gap: 10px;
    padding-bottom: 8px;
    scrollbar-width: thin;
}
.company-tabs::-webkit-scrollbar { height: 4px; }

.company-tabs .nav-link {
    border-radius: 20px;
    padding: 8px 16px;
    background: #f1f3f4;
    border: 1px solid #ddd;
    white-space: nowrap;
    font-size: 14px;
}
.company-tabs .nav-link.active {
    background: #0d6efd;
    color: #fff;
    border-color: #0d6efd;
}

/* ------------------------------------------------------------
   CATEGORY TABS
------------------------------------------------------------ */
.category-tabs {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    white-space: nowrap !important;
    flex-wrap: nowrap !important;
    padding: 6px 0;
}
.category-tabs::-webkit-scrollbar { height: 4px; }

.category-tabs .nav-link {
    background: #f1f3f4;
    border-radius: 18px;
    padding: 6px 14px;
    font-size: 13px;
    border: 1px solid #ddd;
    white-space: nowrap;
}
.category-tabs .nav-link.active {
    background: #0d6efd;
    color: #fff;
    border-color: #0d6efd;
}

/* ------------------------------------------------------------
   PRODUCT GRID
------------------------------------------------------------ */
.product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 20px;
}

/* ------------------------------------------------------------
   PRODUCT CARD
------------------------------------------------------------ */
.product-card {
    background: #fff;
    border-radius: 12px;
    padding: 14px;
    box-shadow: 0 0 10px rgba(0,0,0,0.08);
    transition: 0.2s ease;
}
.product-card:hover { transform: translateY(-3px); }

.product-row {
    display: flex;
    gap: 20px;
    align-items: center;
}

/* Image box */
.product-media-left {
    width: 140px;
    height: 140px;
    background: #fafafa;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.product-media-left img {
    width: 130px;
    height: 130px;
    object-fit: contain;
}

/* Right side */
.product-body-left {
    flex: 1;
    min-width: 160px;
}

.product-title {
    font-size: 15px;
    font-weight: 600;
    margin: 0;
}

.product-price {
    font-size: 16px;
    font-weight: 700;
    color: #28a745;
}

/* Qty Row */
.qty-row {
    display: flex;
    align-items: center;
    margin-top: 10px;
}
.qty-control {
    width: 120px;
}
.item-total {
    margin-left: 12px;
    font-weight: 600;
}

/* ------------------------------------------------------------
   SIDEBAR
------------------------------------------------------------ */
.sticky-card {
    position: sticky;
    top: 90px;
}

/* ------------------------------------------------------------
   MOBILE FRIENDLY
------------------------------------------------------------ */
@media (max-width: 576px) {
    .product-grid {
        grid-template-columns: 1fr !important;
    }
    .product-media-left {
        width: 110px;
        height: 110px;
    }
    .product-media-left img {
        width: 100px;
        height: 100px;
    }
}

</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-5">

    <h2 class="page-title"><i class="bi bi-bag-check me-2"></i>Place a New Order</h2>

    <!-- ===========================
         LAST ORDER STATUS CARD
    ============================ -->
    {% if last_order %}
    <div class="card shadow-sm mb-3" style="border-radius: 12px;">
        <div class="card-body">

            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0 text-primary">
                    <i class="bi bi-clock-history me-2"></i> Last Order Status
                </h6>

                <span class="badge
                    {% if last_order.status == 'pending' %} bg-warning text-dark
                    {% elif last_order.status == 'confirmed' %} bg-success
                    {% elif last_order.status == 'processing' %} bg-info
                    {% elif last_order.status == 'ready' %} bg-primary
                    {% elif last_order.status == 'delivered' %} bg-success
                    {% elif last_order.status == 'cancelled' %} bg-secondary
                    {% elif last_order.status == 'rejected' %} bg-danger
                    {% endif %}
                ">
                    {{ last_order.status|title }}
                </span>
            </div>

            <div class="mt-2 small">
                <strong>Order #:</strong> {{ last_order.order_number }} <br>
                <strong>Date:</strong> {{ last_order.order_date|date:"M d, Y h:i A" }} <br>
                <strong>Amount:</strong> ₹{{ last_order.total_amount|floatformat:2 }}
            </div>

            <div class="text-end mt-2">
                <a href="{% url 'customer_portal:last_order_details' %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye me-1"></i> View Full Order
                </a>
            </div>

        </div>
    </div>
    {% endif %}

    <div class="row gap-4">

        <!-- LEFT: PRODUCT LIST -->
        <div class="col-lg-8">

            <div class="card">
                <div class="card-header d-flex justify-content-between bg-white">
                    <h5><i class="bi bi-cart-plus me-2"></i>New Order</h5>
                    <small class="text-muted">Select items and quantity</small>
                </div>

                <div class="card-body">

                    <!-- COMPANY TABS -->
                    <ul class="nav nav-pills company-tabs mb-3">
                        {% for company, categories in items_by_company.items %}
                        <li class="nav-item">
                            <button class="nav-link {% if forloop.first %}active{% endif %}"
                                data-bs-toggle="tab"
                                data-bs-target="#company-{{ forloop.counter }}">
                                {{ company }}
                            </button>
                        </li>
                        {% endfor %}
                    </ul>

                    <!-- COMPANY CONTENT -->
                    <div class="tab-content">

                        {% for company, categories in items_by_company.items %}
                        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                             id="company-{{ forloop.counter }}">

                            <!-- CATEGORY TABS -->
                            <ul class="nav category-tabs mb-3">
                                {% for category, items in categories.items %}
                                <li class="nav-item">
                                    <button class="nav-link {% if forloop.first %}active{% endif %}"
                                        data-bs-toggle="tab"
                                        data-bs-target="#cat-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                                        {{ category }}
                                    </button>
                                </li>
                                {% endfor %}
                            </ul>

                            <!-- CATEGORY PRODUCT LIST -->
                            <div class="tab-content">

                                {% for category, items in categories.items %}
                                <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                                     id="cat-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">

                                    <div class="product-grid mt-2 pb-3">

                                        {% for item in items %}
                                        <div class="product-card">
                                            <div class="product-row">

                                                <!-- IMAGE -->
                                                <div class="product-media-left">
                                                    <img src="{% if item.image %}{{ item.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}">
                                                </div>

                                                <!-- DETAILS -->
                                                <div class="product-body-left">

                                                    <h6 class="product-title">{{ item.name }}</h6>

                                                    <div class="mt-1">
                                                        <div class="text-muted" style="font-size:13px;">
                                                            MRP: <span style="text-decoration: line-through;">₹{{ item.mrp|floatformat:2 }}</span>
                                                        </div>

                                                        <div class="product-price">
                                                            ₹{{ item.selling_price|floatformat:2 }}
                                                        </div>

                                                        <div style="font-size: 13px; color: #6c757d;">
                                                            Margin: <strong style="color:#28a745;">{{ item.margin_percent }}%</strong>
                                                        </div>
                                                    </div>

                                                    <!-- QTY CONTROL -->
                                                    <div class="qty-row mt-2">
                                                        <div class="input-group input-group-sm qty-control">

                                                            <button type="button" class="btn btn-outline-secondary btn-decr">−</button>

                                                            <input type="number"
                                                                class="form-control qty-input"
                                                                value="0"
                                                                min="0"
                                                                data-item-id="{{ item.id }}"
                                                                data-item-price="{{ item.selling_price }}"
                                                                style="text-align:center;">

                                                            <button type="button" class="btn btn-outline-secondary btn-incr">+</button>

                                                        </div>

                                                        <div class="item-total">₹0.00</div>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                        {% endfor %}

                                    </div>

                                </div>
                                {% endfor %}

                            </div>

                        </div>
                        {% endfor %}

                    </div>

                    <div class="mt-3 d-grid">
                        <button id="placeOrderBtn" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle me-2"></i>Place Order
                        </button>
                    </div>

                </div>
            </div>

        </div>

        <!-- RIGHT: SIDEBAR -->
        <div class="col-lg-3">

            <div class="card sticky-card">
                <div class="card-header bg-white">
                    <h6><i class="bi bi-receipt me-2"></i>Order Summary</h6>
                </div>
                <div class="card-body">
                    <div id="orderSummary"><p class="text-muted small">No items selected</p></div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>Total:</strong>
                        <strong id="grandTotal">₹0.00</strong>
                    </div>
                </div>
            </div>

        </div>

    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    const csrfToken = "{{ csrf_token }}";

    const orderSummaryEl = document.getElementById("orderSummary");
    const grandTotalEl = document.getElementById("grandTotal");
    const placeOrderBtn = document.getElementById("placeOrderBtn");

    /* ---------------- UPDATE TOTALS ---------------- */
    function updateTotals() {
        let grandTotal = 0;
        let summary = "";

        document.querySelectorAll(".product-card").forEach(card => {

            const qtyInput = card.querySelector(".qty-input");
            const qty = parseInt(qtyInput.value) || 0;
            const price = parseFloat(qtyInput.dataset.itemPrice);
            const name = card.querySelector(".product-title").innerText;

            const total = qty * price;

            card.querySelector(".item-total").innerText = "₹" + total.toFixed(2);

            if (qty > 0) {
                grandTotal += total;
                summary += `
                    <div class="d-flex justify-content-between small mb-1">
                        <span>${name} × ${qty}</span>
                        <strong>₹${total.toFixed(2)}</strong>
                    </div>
                `;
            }
        });

        orderSummaryEl.innerHTML = summary || `<p class="text-muted small">No items selected</p>`;
        grandTotalEl.innerText = "₹" + grandTotal.toFixed(2);
    }

    /* ---------------- BUTTON HANDLERS ---------------- */
    document.body.addEventListener("click", function (e) {

        if (e.target.classList.contains("btn-incr")) {
            const input = e.target.closest(".product-card").querySelector(".qty-input");
            input.value = (parseInt(input.value) || 0) + 1;
            updateTotals();
        }

        if (e.target.classList.contains("btn-decr")) {
            const input = e.target.closest(".product-card").querySelector(".qty-input");
            input.value = Math.max(0, (parseInt(input.value) || 0) - 1);
            updateTotals();
        }
    });

    /* ---------------- INPUT CHANGE ---------------- */
    document.body.addEventListener("input", function (e) {
        if (e.target.classList.contains("qty-input")) {
            if (e.target.value < 0 || isNaN(e.target.value)) e.target.value = 0;
            updateTotals();
        }
    });

    /* ---------------- PLACE ORDER ---------------- */
    placeOrderBtn.addEventListener("click", function () {

        const items = [];

        document.querySelectorAll(".qty-input").forEach(input => {
            const qty = parseInt(input.value) || 0;

            if (qty > 0) {
                items.push({
                    item_id: input.dataset.itemId,
                    quantity: qty,
                    price: parseFloat(input.dataset.itemPrice)
                });
            }
        });

        if (items.length === 0) {
            alert("Please select at least one item.");
            return;
        }

        fetch("/customer/orders/place/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({ items: items })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert("Order placed successfully! Order # " + data.order_number);
                window.location.reload();
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(err => console.error("FETCH ERROR:", err));
    });

    updateTotals();
});
</script>
{% endblock %}
