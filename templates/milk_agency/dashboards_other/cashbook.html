{% extends "milk_agency/home/base.html" %}
{% load static %}

{% block title %}CashBook — Premium{% endblock %}

{% block extra_css %}
<style>

/* ------------------------- PREMIUM GLOBAL UI ------------------------- */

body {
    background: linear-gradient(180deg, #f3f7ff 0%, #eef2ff 100%);
}

/* Glass Card */
.premium-card {
    background: rgba(255,255,255,0.55);
    backdrop-filter: blur(10px) saturate(140%);
    -webkit-backdrop-filter: blur(10px) saturate(140%);
    border-radius: 16px;
    padding: 1rem;
    border: 1px solid rgba(12, 11, 11, 0.35);
    box-shadow: 0 6px 26px rgba(20,40,80,0.08);
    transition: all .2s ease-in-out;
}

.premium-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 14px 30px rgba(20,40,80,0.15);
}

/* Gradient left border */
.card-accent {
    position: relative;
    padding-left: 1rem;
}

.card-accent::before {
    content: "";
    position: absolute;
    top: 12px;
    bottom: 12px;
    left: 0;
    width: 6px;
    border-radius: 8px;
    background: linear-gradient(180deg, var(--accent-start), var(--accent-end));
}

/* Titles */
.stat-title {
    font-size: .78rem;
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: .06em;
    color: #555e7a;
}

.stat-value {
    font-size: 1.3rem;
    font-weight: 800;
    margin-top: 4px;
}

/* Round Icon */
.icon-round {
    width: 46px; height: 46px;
    display:flex; align-items:center; justify-content:center;
    border-radius: 12px;
    background: rgba(255,255,255,0.6);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
}

/* Scroll areas */
.custom-scroll {
    max-height: 400px;
    overflow-y: auto;
}

/* Form styling */
.premium-input {
    border-radius: 10px !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
    background: rgba(255,255,255,0.55) !important;
    backdrop-filter: blur(8px) !important;
}

.premium-input:focus {
    border-color: #4e73df !important;
    box-shadow: 0 0 0 3px rgba(78,115,223,0.25) !important;
}

/* Button Premium */
.btn-premium {
    border-radius: 10px;
    padding: 6px 12px;
    font-size: .85rem;
    box-shadow: 0 4px 14px rgba(78,115,223,.2);
    transition: .15s ease;
}

.btn-premium:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(78,115,223,.25);
}

</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- Header -->
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4">
        <h2 class="fw-bold">CashBook</h2>
        <form method="get" class="d-flex gap-2 flex-wrap align-items-center mb-3">

            <select name="month" class="form-select form-select-sm w-auto">
                {% for m, m_name in months %}
                    <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>
                        {{ m_name }}
                    </option>
                {% endfor %}
            </select>

            <select name="year" class="form-select form-select-sm w-auto">
                {% for y in years %}
                    <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>
                        {{ y }}
                    </option>
                {% endfor %}
            </select>

            <button class="btn btn-primary btn-sm btn-premium">
                <i class="bi bi-funnel"></i> Apply
            </button>

        </form>

        <a href="{% url 'milk_agency:cashbook' %}" class="btn btn-outline-secondary btn-sm">
            Reset
        </a>

        <div class="d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-warning btn-sm btn-premium"
                    data-bs-toggle="modal" data-bs-target="#expenseModal">
                <i class="bi bi-cash-coin me-1"></i> Add Expense
            </button>

            <button type="button" class="btn btn-info btn-sm btn-premium"
                    onclick="window.location.href='{% url 'milk_agency:expenses_list' %}'">
                <i class="bi bi-list"></i> View Expenses
            </button>
        </div>
    </div>

    <!-- ---------------------------- SUMMARY CARDS ---------------------------- -->
    <div class="row g-3 mb-4">

        <!-- Cash -->
        <div class="col-lg-2 col-md-3 col-6">
            <div class="premium-card card-accent"
                 style="--accent-start:#4e73df; --accent-end:#2d9cdb;">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stat-title">Cash</div>
                        <div class="stat-value">₹{{ total_cash_in|floatformat:2 }}</div>
                    </div>
                    <div class="icon-round"><i class="bi bi-cash-stack fs-4 text-primary"></i></div>
                </div>
            </div>
        </div>

        <!-- Bank -->
        <div class="col-lg-2 col-md-3 col-6">
            <div class="premium-card card-accent"
                 style="--accent-start:#36b9cc; --accent-end:#67e8f9;">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stat-title">Bank Balance</div>
                        <div class="stat-value">₹{{ bank_balance|floatformat:2 }}</div>
                    </div>
                    <div class="icon-round"><i class="bi bi-bank fs-4 text-info"></i></div>
                </div>
            </div>
        </div>

        <!-- Dues -->
        <div class="col-lg-2 col-md-3 col-6">
            <div class="premium-card card-accent"
                 style="--accent-start:#e74a3b; --accent-end:#ff7676;">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stat-title">Dues</div>
                        <div class="stat-value">₹{{ total_customer_dues|floatformat:2 }}</div>
                    </div>
                    <div class="icon-round"><i class="bi bi-people fs-4 text-danger"></i></div>
                </div>
            </div>
        </div>

        <!-- Net Cash -->
        <div class="col-lg-2 col-md-3 col-6">
            <div class="premium-card card-accent"
                 style="--accent-start:#1cc88a; --accent-end:#8be9b6;">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stat-title">Net Cash</div>
                        <div class="stat-value">₹{{ net_cash|floatformat:2 }}</div>
                    </div>
                    <div class="icon-round"><i class="bi bi-scale fs-4 text-success"></i></div>
                </div>
            </div>
        </div>

        <!-- Expenses -->
        <div class="col-lg-2 col-md-3 col-6">
            <div class="premium-card card-accent"
                 style="--accent-start:#f6c23e; --accent-end:#ffe08a;">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stat-title">Expenses</div>
                        <div class="stat-value">₹{{ total_cash_out|floatformat:2 }}</div>
                    </div>
                    <div class="icon-round"><i class="bi bi-cart fs-4 text-warning"></i></div>
                </div>
            </div>
        </div>

        <!-- Profit -->
        <div class="col-lg-2 col-md-3 col-6">
            <div class="premium-card card-accent"
                 style="--accent-start:#e83e8c; --accent-end:#ff8ac1;">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stat-title">Gross Profit</div>
                        <div class="stat-value">₹{{ monthly_profit|floatformat:2 }}</div>
                    </div>
                    <div class="icon-round"><i class="bi bi-graph-up fs-4 text-danger"></i></div>
                </div>
            </div>
        </div>

        <!-- Stock -->
        <div class="col-lg-2 col-md-3 col-6">
            <div class="premium-card card-accent"
                 style="--accent-start:#6f42c1; --accent-end:#b095f5;">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stat-title">Stock Value</div>
                        <div class="stat-value">₹{{ total_stock_value|floatformat:2 }}</div>
                    </div>
                    <div class="icon-round"><i class="bi bi-box-seam fs-4 text-primary"></i></div>
                </div>
            </div>
        </div>

        <!-- R Amount -->
        <div class="col-lg-2 col-md-3 col-6">
            <div class="premium-card card-accent"
                 style="--accent-start:#fd7e14; --accent-end:#ffb46b;">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stat-title">R Amount</div>
                        <div class="stat-value">₹{{ remaining_amount|floatformat:2 }}</div>
                    </div>
                    <div class="icon-round"><i class="bi bi-calculator fs-4 text-warning"></i></div>
                </div>
            </div>
        </div>

        <!-- Net Profit -->
        <div class="col-lg-2 col-md-3 col-6">
            <div class="premium-card card-accent"
                 style="--accent-start:#f54784; --accent-end:#ff8cb3;">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="stat-title">Net Profit</div>
                        <div class="stat-value">₹{{ net_profit|floatformat:2 }}</div>
                    </div>
                    <div class="icon-round"><i class="bi bi-graph-up-arrow fs-4 text-danger"></i></div>
                </div>
            </div>
        </div>

    </div>


        <!-- Company Dues -->
        <div class="col-md-12 mb-4">
            <div class="premium-card">
                <h6 class="text-warning fw-bold mb-3">Company Dues</h6>

                <div class="row">
                    {% for company in company_dues %}
                    <div class="col-md-6 mb-3">
                        <div class="premium-card p-3"
                             style="background:rgba(255,250,250,0.6);">
                            <h5 class="text-warning">{{ company.company_name }}</h5>
                            <h4 class="{% if company.total_due > 0 %}text-danger{% else %}text-success{% endif %}">
                                ₹{{ company.total_due|floatformat:2 }}
                            </h4>
                            <small class="text-muted">Last updated: {{ company.last_updated|date:"d M Y" }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <hr>
                <h5 class="text-center text-danger fw-bold">Total Dues: ₹{{ total_company_dues|floatformat:2 }}</h5>

                <hr>
                <h6 class="text-info fw-bold">Bank Balance</h6>

                <form method="post" action="{% url 'milk_agency:save_bank_balance' %}">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="number" step="0.01" min="0"
                               class="form-control premium-input"
                               name="amount" value="{{ bank_balance }}">
                        <button class="btn btn-info btn-premium btn-sm">Update</button>
                    </div>
                </form>
            </div>
        </div>


        <!-- Cash In -->
        <div class="col-md-12">
            <div class="premium-card">

                <h6 class="text-primary fw-bold mb-3">Cash In</h6>

                <form method="post" action="{% url 'milk_agency:save_cash_in' %}">
                    {% csrf_token %}

                    <!-- Notes -->
                    <h6 class="text-primary mb-2">Notes</h6>

                    <div class="row">

                        <!-- ₹500 -->
                        <div class="col-lg-2 col-md-3 col-6 mb-3">
                            <label class="form-label">₹500</label>
                            <input type="number" class="form-control premium-input"
                                   name="c500" value="{{ cash_entry.c500 }}">
                            <small class="text-muted">Total: ₹{{ denomination_totals.c500 }}</small>
                        </div>

                        <!-- ₹200 -->
                        <div class="col-lg-2 col-md-3 col-6 mb-3">
                            <label class="form-label">₹200</label>
                            <input type="number" class="form-control premium-input"
                                   name="c200" value="{{ cash_entry.c200 }}">
                            <small class="text-muted">Total: ₹{{ denomination_totals.c200 }}</small>
                        </div>

                        <!-- ₹100 -->
                        <div class="col-lg-2 col-md-3 col-6 mb-3">
                            <label class="form-label">₹100</label>
                            <input type="number" class="form-control premium-input"
                                   name="c100" value="{{ cash_entry.c100 }}">
                            <small class="text-muted">Total: ₹{{ denomination_totals.c100 }}</small>
                        </div>

                        <!-- ₹50 -->
                        <div class="col-lg-2 col-md-3 col-6 mb-3">
                            <label class="form-label">₹50</label>
                            <input type="number" class="form-control premium-input"
                                   name="c50" value="{{ cash_entry.c50 }}">
                            <small class="text-muted">Total: ₹{{ denomination_totals.c50 }}</small>
                        </div>

                        <!-- ₹20 -->
                        <div class="col-lg-2 col-md-3 col-6 mb-3">
                            <label class="form-label">₹20</label>
                            <input type="number" class="form-control premium-input"
                                   name="c20" value="{{ cash_entry.c20 }}">
                            <small class="text-muted">Total: ₹{{ denomination_totals.c20 }}</small>
                        </div>

                        <!-- ₹10 -->
                        <div class="col-lg-2 col-md-3 col-6 mb-3">
                            <label class="form-label">₹10</label>
                            <input type="number" class="form-control premium-input"
                                   name="c10" value="{{ cash_entry.c10 }}">
                            <small class="text-muted">Total: ₹{{ denomination_totals.c10 }}</small>
                        </div>
                    </div>


                    <!-- Coins -->
                    <h6 class="text-success mt-4 mb-2">Coins</h6>

                    <div class="row">

                        <!-- ₹20 -->
                        <div class="col-lg-2 col-md-3 col-6 mb-3">
                            <label class="form-label">₹20</label>
                            <input type="number" class="form-control premium-input"
                                   name="coin20" value="{{ cash_entry.coin20 }}">
                            <small class="text-muted">Total: ₹{{ denomination_totals.coin20 }}</small>
                        </div>

                        <!-- ₹10 -->
                        <div class="col-lg-2 col-md-3 col-6 mb-3">
                            <label class="form-label">₹10</label>
                            <input type="number" class="form-control premium-input"
                                   name="coin10" value="{{ cash_entry.coin10 }}">
                            <small class="text-muted">Total: ₹{{ denomination_totals.coin10 }}</small>
                        </div>

                        <!-- ₹5 -->
                        <div class="col-lg-2 col-md-3 col-6 mb-3">
                            <label class="form-label">₹5</label>
                            <input type="number" class="form-control premium-input"
                                   name="coin5" value="{{ cash_entry.coin5 }}">
                            <small class="text-muted">Total: ₹{{ denomination_totals.coin5 }}</small>
                        </div>

                        <!-- ₹2 -->
                        <div class="col-lg-2 col-md-3 col-6 mb-3">
                            <label class="form-label">₹2</label>
                            <input type="number" class="form-control premium-input"
                                   name="coin2" value="{{ cash_entry.coin2 }}">
                            <small class="text-muted">Total: ₹{{ denomination_totals.coin2 }}</small>
                        </div>

                        <!-- ₹1 -->
                        <div class="col-lg-2 col-md-3 col-6 mb-3">
                            <label class="form-label">₹1</label>
                            <input type="number" class="form-control premium-input"
                                   name="coin1" value="{{ cash_entry.coin1 }}">
                            <small class="text-muted">Total: ₹{{ denomination_totals.coin1 }}</small>
                        </div>

                        <!-- Update Button -->
                        <div class="col-12 mt-2">
                            <button class="btn btn-primary btn-sm btn-premium">Update Cash In</button>
                        </div>

                    </div>

                </form>

            </div>
        </div>

    </div>


    <!-- ------------------------------- EXPENSE MODAL ------------------------------- -->

    <div class="modal fade" id="expenseModal">
        <div class="modal-dialog modal-md modal-dialog-centered">
            <div class="modal-content premium-card p-0">

                <form method="post" action="{% url 'milk_agency:save_expense' %}">
                    {% csrf_token %}

                    <div class="modal-header border-0">
                        <h5 class="fw-bold">Add Expense</h5>
                        <button class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <label class="form-label">Amount</label>
                        <input type="number" name="amount" step="0.01" min="0"
                               class="form-control premium-input mb-3" required>

                        <label class="form-label">Category</label>
                        <select name="category" class="form-select premium-input mb-3" required>
                            <option value="">Select Category</option>
                            <option value="petrol">Petrol</option>
                            <option value="food">Food</option>
                            <option value="others">Others</option>
                        </select>

                        <label class="form-label">Description</label>
                        <textarea name="description" rows="3"
                                  class="form-control premium-input"></textarea>
                    </div>

                    <div class="modal-footer border-0">
                        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button class="btn btn-primary btn-sm btn-premium">Add Expense</button>
                    </div>

                </form>

            </div>
        </div>
    </div>


</div>
{% endblock %}
