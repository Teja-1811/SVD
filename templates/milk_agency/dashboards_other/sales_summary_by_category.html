{% extends "milk_agency/home/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Sales Summary by Category{% endblock %}

{% block extra_css %}
<style>

.container-dashboard {
    padding: 20px 16px;
    max-width: 1400px;
    margin: 0 auto;
}

.page-title {
    font-size: 26px;
    font-weight: 700;
    margin-bottom: 18px;
    color: #0f172a;
}

/* FILTER STRIP */
.filter-strip {
    display: flex;
    gap: 10px;
    padding: 12px;
    margin-bottom: 22px;

    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 6px 24px rgba(0,0,0,0.06);

    overflow-x: auto;
    white-space: nowrap;
    scrollbar-width: none;
}
.filter-strip::-webkit-scrollbar { display: none; }

.filter-pill {
    padding: 8px 18px;
    border-radius: 30px;
    border: 2px solid #d1d5db;
    background: white;
    font-size: 15px;
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: 0.25s;
}
.filter-pill:hover {
    border-color: #3b82f6;
    color: #1d4ed8;
}
.filter-pill.active {
    background: #1d4ed8;
    border-color: #1d4ed8;
    color: white;
    box-shadow: 0 3px 12px rgba(29,78,216,0.25);
}

.select-pill {
    border: 2px solid #d1d5db;
    border-radius: 30px;
    padding: 8px 14px;
    background: white;
}
.select-pill select {
    border: none;
    outline: none;
    font-weight: 600;
    background: transparent;
}

.reset-pill {
    padding: 8px 18px;
    border-radius: 30px;
    border: 2px solid #9ca3af;
    background: white;
    color: #6b7280;
    font-weight: 700;
}
.reset-pill:hover {
    background: #f3f4f6;
}

.mui-card {
    background: white;
    border-radius: 14px;
    padding: 18px;
    margin-bottom: 20px;
    box-shadow: 0px 8px 28px rgba(0,0,0,0.08);
}

.card-header {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 14px;
}

.bottom-row {
    display: grid;
    grid-template-columns: 320px 350px 1fr;
    gap: 20px;
    margin-top: 20px;
}

@media (max-width: 992px) {
    .bottom-row {
        grid-template-columns: 1fr;
    }
}

.table-summary th,
.table-summary td {
    padding: 10px 12px;
    font-size: 14px;
}

.table-summary thead th {
    border-bottom: 2px solid rgba(15,23,42,0.2);
}

</style>
{% endblock %}


{% block content %}
<div class="container-fluid py-4">

    <div class="page-title">Sales Summary by Category</div>

    <!-- FILTER FORM -->
    <form method="get" id="filtersForm">
        <input type="hidden" name="period" id="periodInput" value="{{ period }}">

        <div class="filter-strip">

            <button type="button" class="filter-pill {% if period == 'overall' %}active{% endif %}" data-period="overall">
                Overall
            </button>

            <button type="button" class="filter-pill {% if period == 'today' %}active{% endif %}" data-period="today">
                Today
            </button>

            <button type="button" class="filter-pill {% if period == 'week' %}active{% endif %}" data-period="week">
                Current Week
            </button>

            <button type="button" class="filter-pill {% if period == 'month' %}active{% endif %}" data-period="month">
                Current Month
            </button>

            <button type="button" class="filter-pill {% if period == 'year' %}active{% endif %}" data-period="year">
                Current Year
            </button>

            <div class="select-pill">
                <select name="customer" id="customerFilter">
                    <option value="">All Customers</option>
                    {% for cust in customers %}
                    <option value="{{ cust.id }}" {% if selected_customer == cust.id %}selected{% endif %}>
                        {{ cust.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <button type="button" class="reset-pill" id="resetFilters">Reset</button>

        </div>
    </form>


    <!-- TREND CHART CARD -->
    <div class="mui-card">
        <div class="card-header">Category-wise Volume Trend</div>
        <div style="height:360px;">
            <canvas id="categoryTrendChart"></canvas>
        </div>
    </div>


    <!-- BOTTOM 3-CARD ROW -->
    <div class="bottom-row">

        <!-- Comparison Summary -->
        <div class="mui-card">
            <div class="card-header">Comparison Summary</div>

            <div class="summary-item">
                <div>Total Volume<br><b>{{ total_volume }} L</b></div>
                <div>Compare<br><b>{{ total_compare_volume }} L</b></div>
            </div>

            <div class="summary-item">
                <div>Difference<br><b>{{ diff_volume }} L</b></div>
                <div>Percent<br><b>{% if diff_percent %}{{ diff_percent }}%{% else %}-{% endif %}</b></div>
            </div>
        </div>

        <!-- Year Chart -->
        <div class="mui-card">
            <div class="card-header">Year-wise Total Sales (L)</div>
            <div style="height:320px;">
                <canvas id="yearBarChart"></canvas>
            </div>
        </div>

        <!-- Category Table -->
        <div class="mui-card">
            <div class="card-header">Category-wise Summary Table</div>
            <div style="overflow-x:auto; max-height:320px;">
                <table class="table-summary">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Volume (L)</th>
                            <th>Compare Volume (L)</th>
                            <th>Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cat in categories %}
                        <tr>
                            <td>{{ cat }}</td>
                            <td>{{ data_by_category|get_item:cat|floatformat:3 }}</td>
                            <td>{{ compare_data_by_category|get_item:cat|floatformat:3 }}</td>
                            <td>{{ amount_by_category|get_item:cat|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

</div>
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* JSON FIX */
let categories = [];
try {
    categories = JSON.parse('{{ categories|safe|escapejs }}'.replace(/'/g, '"'));
} catch (e) { categories = []; }

const trend = JSON.parse('{{ trend_by_category_json|escapejs }}');
const yearTotals = JSON.parse('{{ year_totals_json|escapejs }}');
</script>

<script>
/* AUTO SUBMIT */
(() => {
    const form = document.getElementById("filtersForm");
    const periodInput = document.getElementById("periodInput");

    document.querySelectorAll(".filter-pill[data-period]").forEach(btn => {
        btn.onclick = () => {
            periodInput.value = btn.dataset.period;
            form.submit();
        };
    });

    document.getElementById("customerFilter").onchange = () => form.submit();

    document.getElementById("resetFilters").onclick = () => {
        periodInput.value = "overall";
        document.getElementById("customerFilter").selectedIndex = 0;
        form.submit();
    };
})();
</script>

<script>
/* TREND CHART WITH DOT LEGEND */
let labels = [];
let labelSet = new Set();

categories.forEach(cat => {
    (trend[cat] || []).forEach(o => { if (o.date) labelSet.add(o.date); });
});
labels = Array.from(labelSet).sort();

const palette = [
    "#1e88e5","#fb8c00","#43a047","#8e24aa",
    "#f4511e","#3949ab","#00acc1","#c2185b"
];

const datasets = categories.map((cat, i) => {
    const map = {};
    (trend[cat] || []).forEach(o => map[o.date] = Number(o.volume));

    return {
        label: cat,
        data: labels.map(d => map[d] || 0),
        borderColor: palette[i % palette.length],
        backgroundColor: palette[i % palette.length],
        tension: 0.15,
        fill: false,
        pointRadius: 2
    };
});

new Chart(document.getElementById("categoryTrendChart"), {
    type: "line",
    data: { labels, datasets },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: "bottom",
                labels: {
                    usePointStyle: true,
                    pointStyle: "circle",
                    boxWidth: 12,
                    boxHeight: 12
                }
            }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});
</script>

<script>
/* YEAR BAR CHART */
const yearLabels = Object.keys(yearTotals);
const yearValues = Object.values(yearTotals);

new Chart(document.getElementById("yearBarChart"), {
    type: "bar",
    data: {
        labels: yearLabels,
        datasets: [{
            data: yearValues,
            backgroundColor: "#1e88e5"
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
    }
});
</script>

{% endblock %}
