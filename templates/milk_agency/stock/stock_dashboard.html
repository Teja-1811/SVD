{% extends 'milk_agency/home/base.html' %}
{% load static %}

{% block title %}Stock Dashboard{% endblock %}

{% block extra_css %}
<style>
/* ================================
   GLOBAL CARD STYLE (ALL CARDS)
================================ */
.card {
    background: #ffffff;
    border: 1px solid #e4e7eb !important;
    border-radius: 16px !important;
    box-shadow: 0 6px 16px rgba(0,0,0,0.04);
    transition: all .25s ease;
}
.card:hover {
    box-shadow: 0 12px 28px rgba(0,0,0,0.08);
    transform: translateY(-4px);
}

/* ================================
   PASTEL BACKGROUNDS (Option A)
   - summary cards + chart + table
================================ */
/* Summary card pastel variants */
.stat-items { background: linear-gradient(180deg, #f6fbff 0%, #f4f8ff 100%) !important; }   /* Light blue */
.stat-value { background: linear-gradient(180deg, #f6fff7 0%, #f1fff5 100%) !important; }   /* Light green */
.stat-low   { background: linear-gradient(180deg, #fffbef 0%, #fff8e8 100%) !important; }   /* Light yellow */
.stat-move  { background: linear-gradient(180deg, #f7feff 0%, #effcff 100%) !important; }   /* Light aqua */

/* Chart card background */
.chart-card { background: linear-gradient(180deg,#fbfdff 0%, #f7faff 100%) !important; }

/* Table card background */
.table-card { background: linear-gradient(180deg,#ffffff 0%, #fafbfc 100%) !important; }

/* ================================
   SUMMARY CARDS
================================ */
.card.stat-card {
    padding: 1.4rem 1.2rem !important;
    text-align: center;
}
.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 14px;
    background: rgba(0,0,0,0.03);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto .6rem;
}
.stat-title {
    font-size: .9rem;
    color: #6c6c6c;
    margin-bottom: .25rem;
}
.stat-value-number {
    font-size: 1.5rem;
    font-weight: 700;
}

/* ================================
   CHART CARDS & PIE CENTERING
================================ */
.chart-container {
    height: 300px !important;
    position: relative;
}

/* container to center pie */
.pie-container {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 300px;
    padding: 0;
}

/* limit donut size so legend doesn't push it */
#companyChart {
    max-width: 260px !important;
    max-height: 260px !important;
    margin: auto !important;
}

/* ================================
   TABLE CARD
================================ */
.table-responsive {
    border-radius: 12px;
}
#stockOverviewTable thead th {
    background: #eef1f5 !important;
    border-bottom: 1px solid #dfe3e8 !important;
    font-weight: 700;
}
#stockOverviewTable tbody tr:hover {
    background: #f7f9fc !important;
}
.badge.stock-low {
    background: rgba(230,70,70,0.12);
    color: #d62828;
    padding: .4rem .6rem;
    border-radius: 8px;
}
.badge.stock-ok {
    background: rgba(30,150,90,0.15);
    color: #198754;
    padding: .4rem .6rem;
    border-radius: 8px;
}

/* =================================
   TOP RIGHT BUTTON + preview thumbnail
=================================== */
.stock-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}
.header-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* preview thumbnail (uses uploaded file path) */
.dashboard-preview {
    width: 44px;
    height: 28px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid rgba(0,0,0,0.04);
    box-shadow: 0 6px 16px rgba(0,0,0,0.04);
}

/* update button */
.update-btn {
    background: #198754;
    color: #fff;
    padding: 0.55rem 1.15rem;
    border-radius: 14px;
    display: flex;
    align-items: center;
    gap: .45rem;
    font-weight: 500;
    white-space: nowrap;
    text-decoration: none;
    box-shadow: 0 4px 12px rgba(25,135,84,0.25);
    border: 1px solid rgba(255,255,255,0.2);
    transition: all .22s ease;
}
.update-btn:hover {
    background: #187048;
    box-shadow: 0 8px 16px rgba(25,135,84,0.3);
    transform: translateY(-2px);
}
.update-btn i { font-size: 1.15rem; }

/* MOBILE: icon-only */
@media (max-width: 576px) {
    .update-text { display: none !important; }
    .update-btn { padding: 0.55rem 0.7rem !important; border-radius: 12px !important; gap: 0 !important; }
    .update-btn i { font-size: 1.35rem !important; }
    .dashboard-preview { display:none !important; } /* hide preview on tiny screens */
}

/* ================================
   ANIMATION
================================ */
.fade-in-up { opacity: 0; transform: translateY(10px); animation: fadeInUp .5s forwards; }
@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- HEADER -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="stock-header">

        <div>
          <h2 class="fw-bold mb-1">Stock Dashboard</h2>
          <p class="text-muted mb-0">Monitor your inventory and stock levels</p>
        </div>

        <div class="header-right">
          <!-- update button (top-right) -->
          <a href="{% url 'milk_agency:update_stock' %}" class="update-btn">
            <i class="bi bi-pencil-square"></i>
            <span class="update-text">Update Stock</span>
          </a>
        </div>

      </div>
    </div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="row g-3 mb-3">

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card stat-card stat-items fade-in-up">
        <div class="stat-icon bg-primary bg-opacity-10"><i class="bi bi-box-seam text-primary fs-4"></i></div>
        <div class="stat-title">Total Items</div>
        <div class="stat-value-number text-primary" id="total-items">-</div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card stat-card stat-value fade-in-up" style="animation-delay:.05s;">
        <div class="stat-icon bg-success bg-opacity-10"><i class="bi bi-cash text-success fs-4"></i></div>
        <div class="stat-title">Total Stock Value</div>
        <div class="stat-value-number text-success" id="total-stock-value">₹ -</div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card stat-card stat-low fade-in-up" style="animation-delay:.1s;">
        <div class="stat-icon bg-warning bg-opacity-10"><i class="bi bi-exclamation-triangle text-warning fs-4"></i></div>
        <div class="stat-title">Low Stock Items</div>
        <div class="stat-value-number text-warning" id="low-stock-count">-</div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card stat-card stat-move fade-in-up" style="animation-delay:.15s;">
        <div class="stat-icon bg-info bg-opacity-10"><i class="bi bi-arrow-left-right text-info fs-4"></i></div>
        <div class="stat-title">30-Day Movement</div>
        <div class="small">
          <span class="text-success">In: <span id="stock-in">-</span></span> |
          <span class="text-danger">Out: <span id="stock-out">-</span></span>
        </div>
      </div>
    </div>

  </div>

  <!-- CHARTS -->
  <div class="row g-3 mb-3">

    <div class="col-12 col-lg-6">
      <div class="card chart-card p-3 fade-in-up">
        <h6 class="fw-bold mb-3"><i class="bi bi-bar-chart me-2"></i>Top 10 Items by Stock Value</h6>
        <div class="chart-container">
          <canvas id="topItemsChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card chart-card p-3 fade-in-up">
        <h6 class="fw-bold mb-3"><i class="bi bi-pie-chart me-2"></i>Company-wise Stock Value</h6>
        <div class="pie-container">
          <canvas id="companyChart"></canvas>
        </div>
      </div>
    </div>

  </div>

  <!-- STOCK TABLE -->
  <div class="row">
    <div class="col-12">
      <div class="card table-card p-3 fade-in-up">
        <h6 class="fw-bold mb-3"><i class="bi bi-table me-2"></i>Current Stock Overview</h6>

        <div class="table-responsive">
          <table class="table align-middle mb-0" id="stockOverviewTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Item</th>
                <th>Current Stock</th>
                <th>Selling Price</th>
                <th>Stock Value</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ---------- Fetch Dashboard Data ---------- */
fetch("{% url 'milk_agency:stock_data_api' %}")
  .then(res => res.json())
  .then(data => {
    updateSummaryCards(data.summary);
    renderTopItemsChart(data.top_items || []);
    renderCompanyChart(data.company_data || []);
    renderStockOverviewTable(data.all_items || []);
  })
  .catch(err => console.error('Error loading stock data:', err));

/* ---------- Summary Cards ---------- */
function updateSummaryCards(s = {}) {
  const fmt = v => (typeof v === 'number' ? v.toLocaleString('en-IN') : (v || '-'));
  document.getElementById('total-items').textContent = fmt(s.total_items);
  document.getElementById('total-stock-value').textContent = '₹ ' + fmt(s.total_stock_value);
  document.getElementById('low-stock-count').textContent = fmt(s.low_stock_count);
  document.getElementById('stock-in').textContent = fmt(s.stock_in_30d);
  document.getElementById('stock-out').textContent = fmt(s.stock_out_30d);
}

/* ---------- Bar Chart ---------- */
function renderTopItemsChart(items = []) {
  const ctx = document.getElementById('topItemsChart').getContext('2d');
  if (window.topItemsChart && typeof window.topItemsChart.destroy === 'function') window.topItemsChart.destroy();

  window.topItemsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: items.map(i => i.name),
      datasets: [{
        label: 'Stock Value (₹)',
        data: items.map(i => i.stock_value || 0),
        backgroundColor: 'rgba(54,162,235,0.85)',
        borderRadius: 8,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' } },
        x: { grid: { display: false }, ticks: { autoSkip: true } }
      }
    }
  });
}

/* ---------- Doughnut Chart (centered) ---------- */
function renderCompanyChart(data = []) {
  const ctx = document.getElementById('companyChart').getContext('2d');
  if (window.companyChart && typeof window.companyChart.destroy === 'function') window.companyChart.destroy();

  const labels = data.map(d => d.company_name || 'Unknown');
  const values = data.map(d => d.total_value || 0);
  const palette = ['#4e73df','#1cc88a','#f6c23e','#36b9cc','#858796','#fd7e14','#6f42c1','#20c997'];

  window.companyChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: palette,
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: 0 },
      plugins: {
        legend: { position: 'bottom', align: 'center' },
        tooltip: { callbacks: { label: ctx => `₹ ${Number(ctx.raw).toLocaleString('en-IN')}` } }
      },
      elements: {
        arc: { borderWidth: 0 }
      }
    }
  });
}

/* ---------- Table ---------- */
function renderStockOverviewTable(items = []) {
  const tbody = document.querySelector('#stockOverviewTable tbody');
  tbody.innerHTML = '';

  if (!items.length) {
    tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">No stock items found.</td></tr>`;
    return;
  }

  items.forEach((item, idx) => {
    const stock = Number(item.stock_quantity || 0);
    const price = Number(item.selling_price || 0);
    const stockValue = stock * price;
    const lowThreshold = Number(item.min_stock ?? 5);
    const badgeClass = stock <= lowThreshold ? 'stock-low' : 'stock-ok';

    tbody.innerHTML += `
      <tr>
        <td>${idx + 1}</td>
        <td>${escapeHtml(item.name)}${item.company_name ? ' <span class="text-muted">(' + escapeHtml(item.company_name) + ')</span>' : ''}</td>
        <td><span class="badge ${badgeClass}">${stock}</span></td>
        <td>₹ ${price.toLocaleString('en-IN')}</td>
        <td>₹ ${stockValue.toLocaleString('en-IN')}</td>
      </tr>
    `;
  });
}

/* simple escape */
function escapeHtml(unsafe) {
  if (unsafe === null || unsafe === undefined) return '';
  return String(unsafe)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
</script>

{% endblock %}
