{% extends "milk_agency/home/base.html" %}
{% load static %}
{% block title %}Customers Dashboard{% endblock %}

{% block extra_css %}
<style>
/* === Page-specific styles === */

.container-fluid.py-4 { padding-top: 1.25rem; padding-bottom: 1.25rem; }

/* Add Customer Button */
.add-customer-btn {
  background: linear-gradient(90deg,#0066ff,#3b8dff);
  color: #fff !important;
  padding: 10px 18px;
  border-radius: 12px;
  font-weight: 600;
  text-decoration: none;
  box-shadow: 0 6px 18px rgba(10, 60, 120, .12);
  transition: transform .18s ease, box-shadow .18s ease;
}
.add-customer-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 28px rgba(10,60,120,.16); }

.add-icon { font-size: 1.1rem; margin-right: .6rem; }
@media (max-width: 767px) {
  .add-text { display: none; }
  .add-icon{ margin-right:0; font-size:1.4rem; }
}

/* Card/Table visuals */
.card { border-radius: 12px; overflow: hidden; }
.table-responsive { border-radius: 12px; overflow: hidden; }

/* Mobile card */
.customer-card-mobile {
  background: #fff;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 14px;
  border-left: 5px solid #0d6efd;
  box-shadow: 0 8px 22px rgba(8,32,80,0.04);
  position: relative;
}
.card-frozen { border-left-color: #dc3545 !important; }
.customer-header { font-weight:700; font-size:1rem; margin-bottom:6px; }
.customer-divider { height:1px; background:#eef0f3; margin:8px 0; }
.customer-info { font-size:0.92rem; color:#444; line-height:1.45; }

/* Floating action buttons */
.customer-actions {
  position:absolute; right:12px; bottom:12px;
  display:flex; gap:10px;
}

/* Outline button style */
.action-btn {
  width: 35px; height: 35px;
  border-radius: 12px;
  background: transparent !important;
  border: 2px solid #d0d7de !important;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.25rem; color: #444 !important;
  transition: 0.25s ease;
}

.action-btn:hover {
  background: rgba(0,0,0,0.05) !important;
  transform: translateY(-3px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
}

/* Individual button colors */
.info-btn { border-color:#0d6efd !important; color:#0d6efd !important; }
.info-btn:hover { background:#0d6efd !important; color:#fff !important; }

.freeze-btn { border-color:#6c757d !important; color:#6c757d !important; }
.freeze-btn:hover { background:#6c757d !important; color:#fff !important; }

.freeze-active { border-color:#198754 !important; color:#198754 !important; }
.freeze-active:hover { background:#198754 !important; color:#fff !important; }

.whatsapp-btn { border-color:#25d366 !important; color:#25d366 !important; }
.whatsapp-btn:hover { background:#25d366 !important; color:#fff !important; }

.money-btn { border-color:#0d6efd !important; color:#0d6efd !important; }
.money-btn:hover { background:#0d6efd !important; color:#fff !important; }

/* highlight animation */
.updated-highlight {
  animation: highlightFlash .9s ease;
}
@keyframes highlightFlash {
  0% { background-color: rgba(40,167,69,0.12); }
  100% { background-color: transparent; }
}

</style>
{% endblock %}



{% block content %}
<div class="container-fluid py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold mb-1">Customers Dashboard</h2>
      <p class="text-muted mb-0">Manage and track all your customers</p>
    </div>

    <a href="{% url 'milk_agency:add_customer' %}" class="add-customer-btn d-flex align-items-center">
      <i class="bi bi-person-plus-fill add-icon"></i>
      <span class="add-text">Add New Customer</span>
    </a>
  </div>

  <!-- Desktop Table -->
  <div class="d-none d-md-block">
    <div class="card shadow-sm border-0">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0" id="customersTable">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Shop Name</th>
                <th>Retailer ID</th>
                <th>Phone</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              {% for customer in customers %}
              <tr data-customer-id="{{ customer.id }}" class="align-middle {% if customer.frozen %}table-secondary{% endif %}">
                <td>{{ forloop.counter }}</td>
                <td class="fw-medium">{{ customer.name }}</td>
                <td>{{ customer.shop_name|default:"-" }}</td>
                <td><span class="badge bg-light text-dark border">{{ customer.retailer_id|default:"-" }}</span></td>
                <td>{{ customer.phone }}</td>

                <!-- BALANCE COLOR LOGIC -->
                <td class="balance-cell">
                  ₹<span class="balance-value {% if customer.due > 0 %}text-danger{% else %}text-success{% endif %}">
                    {{ customer.due|default:0|floatformat:2 }}
                  </span>
                </td>

                <td class="status-cell">
                  {% if customer.frozen %}
                    <span class="badge bg-danger">Frozen</span>
                  {% else %}
                    <span class="badge bg-success">Active</span>
                  {% endif %}
                </td>

                <td>
                  <div class="btn-group">
                    <a href="{% url 'milk_agency:edit_customer' customer.id %}" class="btn btn-sm btn-outline-info"><i class="bi bi-eye"></i></a>

                    <button class="btn btn-sm freeze-btn btn-outline-{% if customer.frozen %}success{% else %}secondary{% endif %}"
                        data-customer-id="{{ customer.id }}">
                      <i class="bi bi-{% if customer.frozen %}unlock-fill{% else %}lock-fill{% endif %}"></i>
                    </button>

                    <a href="https://wa.me/{{ customer.phone }}" class="btn btn-sm btn-outline-success" target="_blank"><i class="bi bi-whatsapp"></i></a>

                    <button class="btn btn-sm btn-outline-primary balance-btn"
                        data-customer-id="{{ customer.id }}"
                        data-customer-name="{{ customer.name|escapejs }}"
                        data-current-balance="{{ customer.due }}">
                      <i class="bi bi-cash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>
      </div>
    </div>
  </div>


  <!-- MOBILE CARDS -->
  <div class="d-md-none">
    {% for customer in customers %}
    <div class="customer-card-mobile {% if customer.frozen %}card-frozen{% endif %}"
         data-customer-id="{{ customer.id }}">

      <div class="customer-header">
        <span class="customer-index">{{ forloop.counter }}.</span>
        <span>{{ customer.name }}</span>
      </div>

      <div class="customer-divider"></div>

      <div class="customer-info">
        <div><strong>Shop:</strong> {{ customer.shop_name|default:"-" }}</div>

        <!-- MOBILE BALANCE COLOR -->
        <div><strong>Balance:</strong> ₹
          <span class="mobile-balance {% if customer.due > 0 %}text-danger{% else %}text-success{% endif %}">
            {{ customer.due|default:0|floatformat:2 }}
          </span>
        </div>

        <div><strong>Phone:</strong> {{ customer.phone }}</div>
      </div>

      <div class="customer-actions">
        <a href="{% url 'milk_agency:edit_customer' customer.id %}" class="action-btn info-btn">
          <i class="bi bi-eye"></i>
        </a>

        <button class="action-btn freeze-btn {% if customer.frozen %}freeze-active{% endif %}"
                data-customer-id="{{ customer.id }}">
          <i class="bi bi-{% if customer.frozen %}unlock-fill{% else %}lock-fill{% endif %}"></i>
        </button>

        <a href="https://wa.me/{{ customer.phone }}" target="_blank" class="action-btn whatsapp-btn">
          <i class="bi bi-whatsapp"></i>
        </a>

        <button class="action-btn money-btn balance-btn"
                data-customer-id="{{ customer.id }}"
                data-customer-name="{{ customer.name|escapejs }}"
                data-current-balance="{{ customer.due }}">
          <i class="bi bi-cash"></i>
        </button>
      </div>

    </div>
    {% endfor %}
  </div>

</div>


<!-- Balance Modal -->
<div class="modal fade" id="balanceModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update Balance</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form id="balanceForm">
        {% csrf_token %}
        <div class="modal-body">

          <label>Customer:</label>
          <div><strong id="modalCustomerName"></strong></div>

          <label>Current Balance:</label>
          <div>₹<strong id="modalCurrentBalance">0.00</strong></div>

          <label class="mt-2">Update Amount (₹)</label>
          <input type="number" step="0.01" class="form-control" id="balanceAmount" required>

          <input type="hidden" id="balanceCustomerId">
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary btn-sm">Update</button>
        </div>

      </form>
    </div>
  </div>
</div>

{% endblock %}



{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  function getCookie(name) {
    const v = `; ${document.cookie}`;
    const parts = v.split(`; ${name}=`);
    if (parts.length === 2) return parts[1].split(";")[0];
  }

  const csrftoken = getCookie("csrftoken");

  // ================================
  // FREEZE / UNFREEZE (instant update)
  // ================================
  document.querySelectorAll(".freeze-btn").forEach(btn => {
    btn.addEventListener("click", async function () {
      const id = this.dataset.customerId;

      const res = await fetch(`/milk_agency/customer/freeze/${id}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      const data = await res.json();
      if (!data.success) return alert("Failed to update");

      const frozen = data.frozen;

      // Desktop row
      const row = document.querySelector(`tr[data-customer-id="${id}"]`);
      if (row) {
        row.querySelector(".status-cell").innerHTML =
          frozen
            ? '<span class="badge bg-danger">Frozen</span>'
            : '<span class="badge bg-success">Active</span>';

        const btn = row.querySelector(".freeze-btn");
        btn.innerHTML = frozen ? '<i class="bi bi-unlock-fill"></i>' : '<i class="bi bi-lock-fill"></i>';
        btn.classList.toggle("btn-outline-success", frozen);
        btn.classList.toggle("btn-outline-secondary", !frozen);

        row.classList.add("updated-highlight");
        setTimeout(() => row.classList.remove("updated-highlight"), 900);
      }

      // Mobile card
      const card = document.querySelector(`.customer-card-mobile[data-customer-id="${id}"]`);
      if (card) {
        const btn = card.querySelector(".freeze-btn");
        card.classList.toggle("card-frozen", frozen);
        btn.classList.toggle("freeze-active", frozen);

        card.classList.add("updated-highlight");
        setTimeout(() => card.classList.remove("updated-highlight"), 900);
      }
    });
  });


  // =========================================
  // BALANCE MODAL OPEN
  // =========================================
  const modal = new bootstrap.Modal(document.getElementById("balanceModal"));

  document.querySelectorAll(".balance-btn").forEach(btn => {
    btn.addEventListener("click", function () {
      document.getElementById("modalCustomerName").textContent = this.dataset.customerName;
      document.getElementById("modalCurrentBalance").textContent =
        parseFloat(this.dataset.currentBalance).toFixed(2);

      document.getElementById("balanceCustomerId").value = this.dataset.customerId;
      document.getElementById("balanceAmount").value = "";

      modal.show();
    });
  });


  // =========================================
  // BALANCE UPDATE (AJAX + live DOM update)
  // =========================================
  document.getElementById("balanceForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const id = document.getElementById("balanceCustomerId").value;
    const amount = parseFloat(document.getElementById("balanceAmount").value);

    if (isNaN(amount)) return alert("Invalid amount");

    const url = "{% url 'milk_agency:update_customer_balance' 0 %}".replace("0", id);

    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrftoken,
        "X-Requested-With": "XMLHttpRequest",
      },
      body: `balance=${encodeURIComponent(amount)}`,
    });

    const data = await res.json();
    if (!data.success) return alert("Failed");

    const newBalance = parseFloat(data.new_balance).toFixed(2);

    // Desktop update
    const row = document.querySelector(`tr[data-customer-id='${id}']`);
    if (row) {
      const span = row.querySelector(".balance-value");
      span.textContent = newBalance;

      // RED if positive, GREEN if zero or negative
      span.classList.remove("text-danger", "text-success");
      span.classList.add(newBalance > 0 ? "text-danger" : "text-success");

      row.classList.add("updated-highlight");
      setTimeout(() => row.classList.remove("updated-highlight"), 900);
    }

    // Mobile update
    const mobile = document.querySelector(`.customer-card-mobile[data-customer-id='${id}']`);
    if (mobile) {
      const mb = mobile.querySelector(".mobile-balance");
      mb.textContent = newBalance;

      mb.classList.remove("text-danger", "text-success");
      mb.classList.add(newBalance > 0 ? "text-danger" : "text-success");

      mobile.classList.add("updated-highlight");
      setTimeout(() => mobile.classList.remove("updated-highlight"), 900);
    }

    modal.hide();
  });

});
</script>
{% endblock %}
