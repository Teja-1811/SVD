{% extends "milk_agency/home/base.html" %}
{% load static mathfilters %}
{% block title %}Home{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">

<style>

    /* Summary Cards */
    .summary-card {
        border: 1px solid #e7a1a1ff;
        border-radius: 14px;
        background: white;
        box-shadow: 0 4px 14px rgba(0,0,0,0.12);
        padding: 22px;
        height: 100%;
        transition: 0.2s ease;
    }
    .summary-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    /* Company Box */
    .company-header {
        background: linear-gradient(135deg, #5165f3, #7b3fe0);
        color: white;
        padding: 12px 18px;
        border-radius: 12px 12px 0 0;
    }
    .stock-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    /* Responsive tweaks */
    @media (max-width: 768px){
        .table th, .table td {
            padding: 8px;
            font-size: 0.85rem;
        }
    }

    @media (max-width: 480px) {
        .filter-select {
            width: 100% !important;
        }
    }

</style>

{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="min-height: 100vh; background:#f8f9fa;">


    <!-- ----------------------------------- -->
    <!--         SECTION 1: SUMMARY CARDS     -->
    <!-- ----------------------------------- -->
    <div class="row g-3">

        <div class="col-lg-6 col-md-6 col-12">
            <div class="summary-card text-center">
                <div class="text-primary fw-bold fs-5">
                    <i class="bi bi-cart fs-3 me-2"></i> {{ current_date }} Sales
                </div>
                <h3 class="fw-bold mt-2">₹{{ today_sales|floatformat:2 }}</h3>
            </div>
        </div>

        <div class="col-lg-6 col-md-6 col-12">
            <div class="summary-card text-center">
                <div class="text-warning fw-bold fs-5">
                    <i class="bi bi-cash-stack fs-3 me-2"></i> Total Due
                </div>
                <h3 class="fw-bold mt-2">₹{{ total_due|floatformat:2 }}</h3>
            </div>
        </div>

    </div>



    <!-- ----------------------------------- -->
    <!--         SECTION 2: STOCK SUMMARY     -->
    <!-- ----------------------------------- -->
    <div class="row g-3 mt-3">

        <div class="col-xl-3 col-lg-3 col-md-6 col-12">
            <div class="summary-card text-center">
                <div class="text-info fw-bold">
                    <i class="bi bi-box fs-3 me-2"></i>Total Stock Items
                </div>
                <h4 class="fw-bold mt-2">{{ total_stock_items }}</h4>
            </div>
        </div>

        <div class="col-xl-3 col-lg-3 col-md-6 col-12">
            <div class="summary-card text-center">
                <div class="text-success fw-bold">
                    <i class="bi bi-currency-rupee fs-3 me-2"></i>Total Stock Value
                </div>
                <h4 class="fw-bold mt-2">₹{{ total_stock_value|floatformat:2 }}</h4>
            </div>
        </div>

        <div class="col-xl-3 col-lg-3 col-md-6 col-12">
            <div class="summary-card text-center">
                <div class="text-danger fw-bold">
                    <i class="bi bi-exclamation-triangle fs-3 me-2"></i>Low Stock
                </div>
                <h4 class="fw-bold mt-2">{{ low_stock_items }}</h4>
            </div>
        </div>

        <div class="col-xl-3 col-lg-3 col-md-6 col-12">
            <div class="summary-card text-center">
                <div class="text-secondary fw-bold">
                    <i class="bi bi-x-circle fs-3 me-2"></i>Out of Stock
                </div>
                <h4 class="fw-bold mt-2">{{ out_of_stock_items }}</h4>
            </div>
        </div>

    </div>



    <!-- ----------------------------------- -->
    <!--         SECTION 3: FILTER BAR        -->
    <!-- ----------------------------------- -->
    <div class="mt-4 p-3 bg-white rounded shadow-sm">

        <form method="get" id="filterForm" class="d-flex flex-column flex-md-row gap-2">

            <!-- Company -->
            <select name="company" class="form-select w-100"
                    onchange="document.getElementById('filterForm').submit();">
                <option value="">All Companies</option>
                {% for c in companies %}
                <option value="{{ c }}" {% if request.GET.company == c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>

            <!-- Category -->
            <select name="category" class="form-select w-100"
                    onchange="document.getElementById('filterForm').submit();">
                <option value="">All Categories</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>

        </form>

    </div>

    <!-- ----------------------------------- -->
    <!--         SECTION 4: STOCK TABLES      -->
    <!-- ----------------------------------- -->
    <div class="row g-4 mt-2">

        {% for company, items in stock_by_company.items %}
        <div class="col-xl-6 col-lg-6 col-md-12 col-12">

            <div class="stock-card">
                <div class="company-header">
                    <h6 class="fw-bold m-0">
                        <i class="bi bi-building me-2"></i>{{ company }} Stock
                    </h6>
                </div>

                <div class="p-3">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped align-middle">

                            <thead class="table-dark">
                                <tr class="text-center">
                                    <th>Item</th>
                                    <th>Crates</th>
                                    <th>Packets</th>

                                    <!-- HIDE VALUE COLUMN ON MOBILE -->
                                    <th class="d-none d-md-table-cell">Value</th>
                                </tr>
                            </thead>

                            <tbody>
                                {% for item in items %}
                                <tr class="text-center
                                    {% if item.stock_quantity == 0 %}table-danger{% elif item.stock_quantity < 10 %}table-warning{% endif %}">

                                    <!-- Item Name Desktop / Code Mobile -->
                                    <td class="fw-bold">
                                        <span class="d-none d-md-inline">{{ item.name }}</span>
                                        <span class="d-inline d-md-none">{{ item.code }}</span>
                                    </td>

                                    <td>
                                        <span class="badge bg-primary">{{ item.crates|floatformat:0 }}</span>
                                    </td>

                                    <td>
                                        <span class="badge bg-info">{{ item.packets|floatformat:0 }}</span>
                                    </td>

                                    <!-- VALUE → Hidden on mobile -->
                                    <td class="fw-bold text-success d-none d-md-table-cell">
                                        ₹{{ item.stock_value|floatformat:2 }}
                                    </td>

                                </tr>
                                {% endfor %}
                            </tbody>

                        </table>
                    </div>
                </div>

            </div>

        </div>
        {% endfor %}

    </div>


</div>
{% endblock %}
