{% extends "milk_agency/home/base.html" %}
{% load static %}
{% load mathfilters %}
{% block title %}Items Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}" />

<style>

/* ===================== TOP BAR ===================== */
.top-bar{
  width:100%;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:15px;
  flex-wrap:nowrap;
}

.logo-scroll{
  display:flex;
  gap:12px;
  overflow-x:auto;
  padding-bottom:5px;
}

.company-filter-logo{
  width:70px;
  height:70px;
  border-radius:50%;
  background:#fff;
  border:2px solid #eee;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:6px;
  transition:0.2s;
}

.company-filter-logo img{
  width:100%;
  height:100%;
  object-fit:contain;
}

.company-filter-logo.active{
  border:3px solid #28a745 !important;
}

/* Refresh Button */
.refresh-logo{
  width:70px;
  height:70px;
  border-radius:50%;
  border:2px dashed #28a745;
  color:#28a745;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:28px;
}

/* Search */
.search-box{
  width:320px;
  max-width:100%;
}

/* ================= PRODUCT CARD ================= */
.item-card{
  background:#fff;
  border-radius:14px;
  border:1.5px solid #dcdcdc;
  overflow:hidden;
  position:relative;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
}

/* Company Logo */
.item-company-logo{
  position:absolute;
  top:15px;
  left:15px;
  width:75px;
  height:75px;
  border-radius:50%;
  background:#fff;
  border:2px solid #eee;
  display:flex;
  justify-content:center;
  align-items:center;
}

/* Stock Badge */
.stock-badge{
  position:absolute;
  top:15px;
  right:15px;
  padding:4px 12px;
  border-radius:50px;
  font-size:0.8rem;
  font-weight:600;
  color:#fff;
}

.in-stock{ background:#28a745; }
.no-stock{ background:#dc3545; }

/* Product Image */
.item-image-box{
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
  margin-top:30px;
}

/* Title */
.item-title{
  font-weight:700;
  margin:10px 0 10px;
}

/* Prices */
.item-prices small{ color:#777; }
.price-buy{ color:#007bff; font-weight:600; }
.price-sell{ color:#28a745; font-weight:600; }

/* Buttons */
.item-buttons{
  display:flex;
  gap:12px;
  margin-top:10px;
}

.edit-btn{
  flex:1;
  border-radius:10px;
  border:1px solid #2c8f46;
  background:#e6f7ec;
  color:#2c8f46;
  padding:10px;
  font-weight:600;
}

.freeze-btn{
  flex:1;
  border-radius:10px;
  border:1px solid #d22a2a;
  background:#ffe9e9;
  color:#d22a2a;
  padding:10px;
  font-weight:600;
}
</style>
{% endblock %}


{% block content %}

<div class="container-fluid py-4">

  <h2 class="fw-bold mb-3">Items Dashboard</h2>

  <!-- ===================== TOP BAR ===================== -->
  <div class="top-bar">

    <div class="logo-scroll p-2">
      {% for c in companies %}
      <a href="?company={{ c.id }}"
         class="company-filter-logo {% if request.GET.company == c.id|stringformat:'s' %}active{% endif %}">
        <img src="{{ c.logo.url }}">
      </a>
      {% endfor %}

      <a href="?company=all"
         class="refresh-logo {% if request.GET.company == 'all' or not request.GET.company %}active{% endif %}">
         <i class="bi bi-arrow-clockwise"></i>
      </a>
    </div>

    <div class="actions">
      <div class="input-group search-box">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="search" id="itemSearchInput" class="form-control" placeholder="Search Items">
      </div>

      <a href="{% url 'milk_agency:add_item' %}" class="btn btn-outline-success p-3">
        <i class="bi bi-plus-circle fs-4"></i>
        <span class="ms-2">Add Item</span>
      </a>
    </div>

  </div>

  <hr>

  <!-- ===================== ITEMS ===================== -->
  {% for category, items in grouped_items.items %}
  {% if items %}

  <h3 class="mt-4">{{ category|title }}</h3>

  <div class="row g-3">

    {% for item in items %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3 item-col">

      <div class="item-card">

        <div class="item-company-logo">
          <img src="{{ item.company.logo.url }}" width="100%">
        </div>

        <span class="stock-badge {% if item.stock_quantity > 0 %}in-stock{% else %}no-stock{% endif %}">
          {{ item.stock_quantity }} in stock
        </span>

        <div class="item-image-box">
          {% if item.image %}
          <img src="{{ item.image.url }}" height="160">
          {% else %}
          <i class="bi bi-image fs-1 text-muted"></i>
          {% endif %}
        </div>

        <div class="p-3">

          <h6 class="item-title">{{ item.name }}</h6>

          <div class="item-prices">
            <small>Buying</small>
            <div class="price-buy">₹{{ item.buying_price }}</div>

            <small>Selling</small>
            <div class="price-sell">₹{{ item.selling_price }}</div>
          </div>

          <div class="item-buttons">

            <button class="edit-btn"
              onclick="location.href='{% url 'milk_agency:edit_item' item.id %}'">
              Edit
            </button>

            <button class="freeze-btn"
              onclick="freezeItem({{ item.id }}, '{{ item.name }}')">
              {% if item.frozen %}Unfreeze{% else %}Freeze{% endif %}
            </button>

          </div>

        </div>

      </div>

    </div>
    {% endfor %}

  </div>

  {% endif %}
  {% endfor %}

</div>

<!-- ================= JS ================= -->
<script>

document.getElementById("itemSearchInput")
.addEventListener("keyup", function(){
  let val = this.value.toLowerCase();
  document.querySelectorAll(".item-card").forEach(card=>{
    let name = card.querySelector(".item-title").textContent.toLowerCase();
    card.closest(".item-col").style.display = name.includes(val) ? "" : "none";
  });
});

function freezeItem(id,name){
  if(!confirm(`Freeze/Unfreeze "${name}"?`)) return;
  fetch(`/milk_agency/freeze-item/${id}/`,{
    method:"POST",
    headers:{
      "X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value,
      "X-Requested-With":"XMLHttpRequest",
    },
  }).then(r=>r.json()).then(()=>location.reload());
}

</script>

{% endblock %}
