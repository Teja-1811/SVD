{% extends "milk_agency/home/base.html" %}

{% block title %}Customer Data{% endblock %}

{% block head %}
<style>
/* Print-specific styles for customer cards */
@media print {
    /* Hide non-essential elements */
    nav, header, .message-container-top-right, .d-flex.justify-content-between.mb-3,
    .mb-3 .row, .btn, form, .freeze-btn, .btn-outline-warning, .btn-outline-success {
        display: none !important;
    }

    /* Preserve body layout */
    body {
        margin: 0 !important;
        padding: 15mm !important;
        background: white !important;
        font-family: Arial, sans-serif !important;
    }

    /* Customer cards grid for print */
    .row {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 20px !important;
        margin: 0 !important;
    }

    .col-lg-4.col-md-6.mb-4 {
        break-inside: avoid !important;
        page-break-inside: avoid !important;
        margin-bottom: 20px !important;
    }

    /* Customer card styling for print */
    .card {
        border: 2px solid #000 !important;
        border-radius: 8px !important;
        box-shadow: none !important;
        margin: 0 !important;
        background: white !important;
        page-break-inside: avoid !important;
    }

    .card-body {
        padding: 15px !important;
    }

    .card-title {
        font-size: 16px !important;
        font-weight: bold !important;
        margin-bottom: 10px !important;
        color: #000 !important;
    }

    .card-text {
        font-size: 11px !important;
        margin-bottom: 4px !important;
        line-height: 1.3 !important;
    }

    .card-text strong {
        font-weight: bold !important;
    }

    /* Print header */
    .print-header {
        display: block !important;
        text-align: center !important;
        margin-bottom: 20px !important;
        border-bottom: 2px solid #000 !important;
        padding-bottom: 10px !important;
    }

    .print-header h2 {
        font-size: 20px !important;
        font-weight: bold !important;
        margin: 0 !important;
    }

    .print-header p {
        font-size: 12px !important;
        margin: 5px 0 0 0 !important;
    }

    /* Page settings */
    @page {
        margin: 15mm;
        size: A4 portrait;
    }

    /* Handle frozen customer cards */
    .bg-light {
        background-color: #f8f9fa !important;
        border: 2px solid #6c757d !important;
    }
}

/* Screen-specific styles */
@media screen {
    .print-only {
        display: none;
    }

    .print-btn {
        background-color: #17a2b8 !important;
        border-color: #17a2b8 !important;
    }

    .print-btn:hover {
        background-color: #138496 !important;
        border-color: #117a8b !important;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Print Header (hidden on screen, visible when printing) -->
<div class="print-header print-only">
    <h2>Sri Vijaya Durga Milk Agencies</h2>
    <p>Customer Information Report - Generated on <span id="print-date">{{ "now"|date:"d M Y" }}</span></p>
</div>
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Customer Management</h2>
        <a href="{% url 'milk_agency:add_customer' %}" class="btn btn-outline-primary">
            <i class="bi bi-person-plus"></i> Add Customer
        </a>
    </div>
    
    <!-- Search Bar -->
    <div class="mb-3">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" id="searchInput" class="form-control" placeholder="Search customers by name, shop name, retailer ID, or phone...">
        </div>
    </div>

    <div class="table-responsive text-center">
        <table class="table table-striped table-hover" id="customer-table">
            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Shop Name</th>
                    <th>Retailer ID</th>
                    <th>Phone</th>
                    <th>Last Paid</th>
                    <th>Balance</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="customer-tbody">
                {% for customer in customers %}
                <tr class="{% if customer.frozen %}table-secondary{% endif %}">
                    <td>{{ customer.name }}</td>
                    <td>{{ customer.shop_name|default:"-" }}</td>
                    <td>{{ customer.retailer_id|default:"-" }}</td>
                    <td>{{ customer.phone }}</td>
                    <td class="text-success">₹{{ customer.last_paid_balance|default:0|floatformat:2 }}</td>
                    <td class="text-danger">₹{{ customer.due|default:0|floatformat:2 }}</td>
                    <td>
                        {% if customer.frozen %}
                            <span class="badge bg-danger">Frozen</span>
                        {% else %}
                            <span class="badge bg-success">Active</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <a href="{% url 'milk_agency:edit_customer' customer.id %}" class="btn btn-sm btn-outline-warning" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-{% if customer.frozen %}success{% else %}danger{% endif %} freeze-btn"
                                    title="{% if customer.frozen %}Unfreeze{% else %}Freeze{% endif %}"
                                    data-customer-id="{{ customer.id }}"
                                    data-csrf-token="{{ csrf_token }}">
                                <i class="bi bi-{% if customer.frozen %}unlock{% else %}lock{% endif %}"></i>
                            </button>
                            <a href="https://wa.me/{{ customer.phone }}?text=Hello%20{{ customer.name|urlencode }}%2C%0A%0AHere%20is%20your%20account%20summary%3A%0A%0ADue%3A%20Rs.%20{{ customer.due|default:0|floatformat:2 }}%0A%0AThank%20you%20for%20your%20business!"
                                class="btn btn-sm btn-outline-success"
                                title="Share Balance via WhatsApp"
                                target="_blank">
                                <i class="bi bi-whatsapp"></i>
                            </a>
                            <!-- Balance Update Form -->
                            <form method="post" action="{% url 'milk_agency:update_customer_balance' customer.id %}" class="d-inline">
                                {% csrf_token %}
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" step="0.01" class="form-control form-control-sm" name="balance"
                                           placeholder="Update" value="0" required style="width: 80px;">
                                    <button type="submit" class="btn btn-outline-primary btn-sm" title="Update Balance">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center">No customers found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Hidden forms for freeze/unfreeze actions -->
    {% for customer in customers %}
    <form method="post" action="{% url 'milk_agency:freeze_customer' customer.id %}" class="d-none" id="freeze-form-{{ customer.id }}">
        {% csrf_token %}
    </form>
    {% endfor %}
</div>

            <script>
                // JavaScript to handle freeze/unfreeze button clicks and search functionality
                document.addEventListener('DOMContentLoaded', function() {
                    const searchInput = document.getElementById('searchInput');
                    const customerTbody = document.getElementById('customer-tbody');
                    const rows = customerTbody.querySelectorAll('tr');

                    function getCookie(name) {
                        let cookieValue = null;
                        if (document.cookie && document.cookie !== '') {
                            const cookies = document.cookie.split(';');
                            for (let i = 0; i < cookies.length; i++) {
                                const cookie = cookies[i].trim();
                                // Does this cookie string begin with the name we want?
                                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }

                    function filterRows() {
                        const query = searchInput.value.toLowerCase();
                        let visibleCount = 0;
                        rows.forEach(row => {
                            const cells = row.querySelectorAll('td');
                            if (cells.length > 0) {
                                const name = cells[0].textContent.toLowerCase();
                                const shopName = cells[1].textContent.toLowerCase();
                                const retailerId = cells[2].textContent.toLowerCase();
                                const phone = cells[3].textContent.toLowerCase();
                                if (name.includes(query) || shopName.includes(query) || retailerId.includes(query) || phone.includes(query)) {
                                    row.style.display = '';
                                    visibleCount++;
                                } else {
                                    row.style.display = 'none';
                                }
                            }
                        });
                        // Update no results message
                        const noResultsRow = customerTbody.querySelector('.no-results');
                        if (visibleCount === 0 && rows.length > 0) {
                            if (!noResultsRow) {
                                const newRow = document.createElement('tr');
                                newRow.className = 'no-results';
                                newRow.innerHTML = '<td colspan="8" class="text-center">No customers found matching your search.</td>';
                                customerTbody.appendChild(newRow);
                            }
                        } else if (noResultsRow) {
                            noResultsRow.remove();
                        }
                    }

                    searchInput.addEventListener('input', filterRows);

                    function attachFreezeEventListeners() {
                        document.querySelectorAll('.freeze-btn').forEach(button => {
                            button.addEventListener('click', function(event) {
                                event.preventDefault();
                                const customerId = this.getAttribute('data-customer-id');
                                const csrftoken = getCookie('csrftoken');
                                fetch(`/milk_agency/customer/freeze/${customerId}/`, {
                                    method: 'POST',
                                    headers: {
                                        'X-CSRFToken': csrftoken,
                                        'X-Requested-With': 'XMLHttpRequest',
                                    },
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        // Reload the page after freeze/unfreeze
                                        window.location.reload();
                                    } else {
                                        alert('Failed to update customer status.');
                                    }
                                })
                                .catch(error => {
                                    console.error('Error freezing/unfreezing customer:', error);
                                });
                            });
                        });
                    }

                    // Initial attach freeze event listeners
                    attachFreezeEventListeners();
                });
            </script>
{% endblock %}
