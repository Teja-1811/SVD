{% extends 'milk_agency/home/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">

    <!-- Date Filter Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Filter by Date Range</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="text" id="startDate" class="form-control" placeholder="Select start date">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="text" id="endDate" class="form-control" placeholder="Select end date">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-primary d-block me-5" onclick="applyDateFilter()">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <button type="button" class="btn btn-success" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs" id="salesTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab" aria-controls="weekly" aria-selected="true">
                <i class="fas fa-calendar-week"></i> Weekly
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab" aria-controls="monthly" aria-selected="false">
                <i class="fas fa-calendar-alt"></i> Monthly
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly" type="button" role="tab" aria-controls="yearly" aria-selected="false">
                <i class="fas fa-calendar"></i> Yearly
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="overall-tab" data-bs-toggle="tab" data-bs-target="#overall" type="button" role="tab" aria-controls="overall" aria-selected="false">
                <i class="fas fa-chart-line"></i> Overall
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="salesTabsContent">
        <!-- Weekly Tab -->
        <div class="tab-pane fade show active" id="weekly" role="tabpanel" aria-labelledby="weekly-tab">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Weekly Sales Trend</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Tab -->
        <div class="tab-pane fade" id="monthly" role="tabpanel" aria-labelledby="monthly-tab">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Monthly Sales Trend</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Yearly Tab -->
        <div class="tab-pane fade" id="yearly" role="tabpanel" aria-labelledby="yearly-tab">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Yearly Sales Trend</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall Tab -->
        <div class="tab-pane fade" id="overall" role="tabpanel" aria-labelledby="overall-tab">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Overall Sales Trend</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="overallChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom CSS -->
<link rel="stylesheet" href="{% static 'milk_agency/css/sales_dashboard.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<!-- JavaScript for Charts and Interactivity -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
// Global variables
let charts = {};
let currentTab = 'weekly';

// Initialize date pickers
document.addEventListener('DOMContentLoaded', function() {
    flatpickr('#startDate', {
        dateFormat: 'Y-m-d',
        maxDate: 'today'
    });

    flatpickr('#endDate', {
        dateFormat: 'Y-m-d',
        maxDate: 'today'
    });

    // Load initial data
    loadSalesSummary();
    loadChartData('weekly');

    // Add tab change listeners
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            currentTab = event.target.id.replace('-tab', '');
            loadChartData(currentTab);
        });
    });
});

// Load sales summary
function loadSalesSummary() {
    fetch('/api/sales/summary/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalSales').textContent = '₹' + data.total_sales.toLocaleString();
            document.getElementById('totalPaid').textContent = '₹' + data.total_paid.toLocaleString();
            document.getElementById('totalDue').textContent = '₹' + data.total_due.toLocaleString();
            document.getElementById('totalBills').textContent = data.total_bills.toLocaleString();
        })
        .catch(error => console.error('Error loading summary:', error));
}

// Load chart data based on tab
function loadChartData(tab) {
    const chartCanvas = document.getElementById(tab + 'Chart');
    const url = `/api/sales/${tab}/`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (charts[tab]) {
                charts[tab].destroy();
            }

            charts[tab] = new Chart(chartCanvas, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading chart:', error));
}

// Apply date filter
function applyDateFilter() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }

    const url = `/api/sales/filter/?start_date=${startDate}&end_date=${endDate}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Update charts with filtered data
            if (charts[currentTab]) {
                charts[currentTab].data = data;
                charts[currentTab].update();
            }
        })
        .catch(error => console.error('Error applying filter:', error));
}

// Refresh data
function refreshData() {
    loadSalesSummary();
    loadChartData(currentTab);
}

// Export data function
function exportData() {
    alert('Export functionality would be implemented here');
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

<style>
.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}
.chart-container {
    position: relative;
    height: 400px;
    width: 100%;
}
.tab-content {
    padding-top: 20px;
}
.nav-tabs .nav-link {
    color: #495057;
    font-weight: 500;
}
.nav-tabs .nav-link.active {
    color: #007bff;
    font-weight: 600;
}
</style>
{% endblock %}
