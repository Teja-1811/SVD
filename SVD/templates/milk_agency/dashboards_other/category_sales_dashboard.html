{% extends 'milk_agency/home/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <!-- Dashboard Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-bar-chart-line"></i> Category Sales Statistics
        </h2>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-primary" onclick="refreshAllData()">
                <i class="bi bi-sync"></i>Refresh
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Today's Volume
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="todayVolume">0 L</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-graph-up fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                This Week
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="weekVolume">0 L</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-calendar-week fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                This Month
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="monthVolume">0 L</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-calendar3 fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                This Year
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="yearVolume">0 L</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-calendar4-week fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs" id="categorySalesTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="today-tab" data-bs-toggle="tab" data-bs-target="#today" type="button" role="tab" aria-controls="today" aria-selected="true">
                <i class="bi bi-calendar-day"></i> Today
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab" aria-controls="weekly" aria-selected="false">
                <i class="bi bi-calendar-week"></i> Weekly
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab" aria-controls="monthly" aria-selected="false">
                <i class="bi bi-calendar3"></i> Monthly
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly" type="button" role="tab" aria-controls="yearly" aria-selected="false">
                <i class="bi bi-calendar4-week"></i> Yearly
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button" role="tab" aria-controls="trends" aria-selected="false">
                <i class="bi bi-graph-up"></i> Trends
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">
                <i class="bi bi-clock-history"></i> History
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="categorySalesTabsContent">
        <!-- Today Tab -->
        <div class="tab-pane fade show active" id="today" role="tabpanel" aria-labelledby="today-tab">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Today's Category-wise Sales Volume</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="todayChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Today's Summary</h6>
                        </div>
                        <div class="card-body">
                            <div id="todaySummary">
                                <p class="text-muted">Loading today's data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Tab -->
        <div class="tab-pane fade" id="weekly" role="tabpanel" aria-labelledby="weekly-tab">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">This Week's Category-wise Sales Volume</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="weeklyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Weekly Summary</h6>
                        </div>
                        <div class="card-body">
                            <div id="weeklySummary">
                                <p class="text-muted">Loading weekly data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Tab -->
        <div class="tab-pane fade" id="monthly" role="tabpanel" aria-labelledby="monthly-tab">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">This Month's Category-wise Sales Volume</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Monthly Summary</h6>
                        </div>
                        <div class="card-body">
                            <div id="monthlySummary">
                                <p class="text-muted">Loading monthly data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Yearly Tab -->
        <div class="tab-pane fade" id="yearly" role="tabpanel" aria-labelledby="yearly-tab">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">This Year's Category-wise Sales Volume</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="yearlyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Yearly Summary</h6>
                        </div>
                        <div class="card-body">
                            <div id="yearlySummary">
                                <p class="text-muted">Loading yearly data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trends Tab -->
        <div class="tab-pane fade" id="trends" role="tabpanel" aria-labelledby="trends-tab">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Monthly Volume Trends (Last 12 Months)</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="monthlyTrendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Yearly Volume Trends (Last 5 Years)</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="yearlyTrendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Historical Category Sales Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="historyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom CSS -->
<style>
.chart-container {
    position: relative;
    height: 400px;
    width: 100%;
}
.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}
.nav-tabs .nav-link {
    color: #495057;
    font-weight: 500;
}
.nav-tabs .nav-link.active {
    color: #007bff;
    font-weight: 600;
}
.summary-item {
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}
.summary-item:last-child {
    border-bottom: none;
}
.category-volume {
    font-size: 1.1em;
    font-weight: bold;
    color: #007bff;
}
</style>

<!-- JavaScript for Charts and Interactivity -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let charts = {};
let currentTab = 'today';

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadSummaryData();
    loadTabData('today');

    // Add tab change listeners
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            currentTab = event.target.id.replace('-tab', '');
            loadTabData(currentTab);
        });
    });
});

// Load summary data for cards
function loadSummaryData() {
    fetch('/api/category-sales/summary/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('todayVolume').textContent = data.today.volume.toFixed(2) + ' L';
            document.getElementById('weekVolume').textContent = data.week.volume.toFixed(2) + ' L';
            document.getElementById('monthVolume').textContent = data.month.volume.toFixed(2) + ' L';
            document.getElementById('yearVolume').textContent = data.year.volume.toFixed(2) + ' L';
        })
        .catch(error => console.error('Error loading summary:', error));
}

// Load tab-specific data
function loadTabData(tab) {
    switch(tab) {
        case 'today':
            loadTodayData();
            break;
        case 'weekly':
            loadWeeklyData();
            break;
        case 'monthly':
            loadMonthlyData();
            break;
        case 'yearly':
            loadYearlyData();
            break;
        case 'trends':
            loadTrendsData();
            break;
        case 'history':
            loadHistoryData();
            break;
    }
}

// Load today's data
function loadTodayData() {
    fetch('/api/category-sales/today/')
        .then(response => response.json())
        .then(data => {
            renderTodayChart(data);
            renderTodaySummary(data);
        })
        .catch(error => console.error('Error loading today data:', error));
}

// Load weekly data
function loadWeeklyData() {
    fetch('/api/category-sales/week/')
        .then(response => response.json())
        .then(data => {
            renderWeeklyChart(data);
            renderWeeklySummary(data);
        })
        .catch(error => console.error('Error loading weekly data:', error));
}

// Load monthly data
function loadMonthlyData() {
    fetch('/api/category-sales/month/')
        .then(response => response.json())
        .then(data => {
            renderMonthlyChart(data);
            renderMonthlySummary(data);
        })
        .catch(error => console.error('Error loading monthly data:', error));
}

// Load yearly data
function loadYearlyData() {
    fetch('/api/category-sales/year/')
        .then(response => response.json())
        .then(data => {
            renderYearlyChart(data);
            renderYearlySummary(data);
        })
        .catch(error => console.error('Error loading yearly data:', error));
}

// Load trends data
function loadTrendsData() {
    // Load monthly trends
    fetch('/api/category-sales/monthly-history/')
        .then(response => response.json())
        .then(data => {
            renderMonthlyTrendsChart(data);
        })
        .catch(error => console.error('Error loading monthly trends:', error));

    // Load yearly trends
    fetch('/api/category-sales/yearly-history/')
        .then(response => response.json())
        .then(data => {
            renderYearlyTrendsChart(data);
        })
        .catch(error => console.error('Error loading yearly trends:', error));
}

// Load history data
function loadHistoryData() {
    fetch('/api/category-sales/monthly-history/')
        .then(response => response.json())
        .then(data => {
            renderHistoryChart(data);
        })
        .catch(error => console.error('Error loading history data:', error));
}

// Chart rendering functions
function renderTodayChart(data) {
    const ctx = document.getElementById('todayChart');
    if (charts.today) charts.today.destroy();

    const labels = Object.keys(data.categories);
    const volumes = Object.values(data.categories).map(cat => cat.volume);

    charts.today = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: volumes,
                backgroundColor: [
                    'rgb(75, 192, 192)',
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)',
                    'rgb(153, 102, 255)',
                    'rgb(255, 159, 64)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
}

function renderWeeklyChart(data) {
    const ctx = document.getElementById('weeklyChart');
    if (charts.weekly) charts.weekly.destroy();

    const labels = Object.keys(data.categories);
    const volumes = Object.values(data.categories).map(cat => cat.volume);

    charts.weekly = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Volume (L)',
                data: volumes,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgb(75, 192, 192)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Volume (Liters)'
                    }
                }
            }
        }
    });
}

function renderMonthlyChart(data) {
    const ctx = document.getElementById('monthlyChart');
    if (charts.monthly) charts.monthly.destroy();

    const labels = Object.keys(data.categories);
    const volumes = Object.values(data.categories).map(cat => cat.volume);

    charts.monthly = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Volume (L)',
                data: volumes,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Volume (Liters)'
                    }
                }
            }
        }
    });
}

function renderYearlyChart(data) {
    const ctx = document.getElementById('yearlyChart');
    if (charts.yearly) charts.yearly.destroy();

    const labels = Object.keys(data.categories);
    const volumes = Object.values(data.categories).map(cat => cat.volume);

    charts.yearly = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Volume (L)',
                data: volumes,
                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                borderColor: 'rgb(255, 99, 132)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Volume (Liters)'
                    }
                }
            }
        }
    });
}

function renderMonthlyTrendsChart(data) {
    const ctx = document.getElementById('monthlyTrendsChart');
    if (charts.monthlyTrends) charts.monthlyTrends.destroy();

    charts.monthlyTrends = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Volume (Liters)'
                    }
                }
            }
        }
    });
}

function renderYearlyTrendsChart(data) {
    const ctx = document.getElementById('yearlyTrendsChart');
    if (charts.yearlyTrends) charts.yearlyTrends.destroy();

    charts.yearlyTrends = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Volume (Liters)'
                    }
                }
            }
        }
    });
}

function renderHistoryChart(data) {
    const ctx = document.getElementById('historyChart');
    if (charts.history) charts.history.destroy();

    charts.history = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Volume (Liters)'
                    }
                }
            }
        }
    });
}

// Summary rendering functions
function renderTodaySummary(data) {
    const container = document.getElementById('todaySummary');
    let html = `<div class="summary-item">
        <strong>Date:</strong> ${data.date}
    </div>`;

    Object.entries(data.categories).forEach(([category, catData]) => {
        html += `<div class="summary-item">
            <span class="category-volume">${category}: ${catData.volume.toFixed(2)} L</span>
            <small class="text-muted">(₹${catData.amount.toFixed(2)})</small>
        </div>`;
    });

    html += `<div class="summary-item">
        <strong>Total Volume:</strong> <span class="category-volume">${data.total_volume.toFixed(2)} L</span>
    </div>`;

    container.innerHTML = html;
}

function renderWeeklySummary(data) {
    const container = document.getElementById('weeklySummary');
    let html = `<div class="summary-item">
        <strong>Week:</strong> ${data.week_start} to ${data.week_end}
    </div>`;

    Object.entries(data.categories).forEach(([category, catData]) => {
        html += `<div class="summary-item">
            <span class="category-volume">${category}: ${catData.volume.toFixed(1)} L</span>
            <small class="text-muted">(₹${catData.amount.toFixed(2)})</small>
        </div>`;
    });

    html += `<div class="summary-item">
        <strong>Total Volume:</strong> <span class="category-volume">${data.total_volume.toFixed(1)} L</span>
    </div>`;

    container.innerHTML = html;
}

function renderMonthlySummary(data) {
    const container = document.getElementById('monthlySummary');
    let html = `<div class="summary-item">
        <strong>Month:</strong> ${data.month}
    </div>`;

    Object.entries(data.categories).forEach(([category, catData]) => {
        html += `<div class="summary-item">
            <span class="category-volume">${category}: ${catData.volume.toFixed(1)} L</span>
            <small class="text-muted">(₹${catData.amount.toFixed(2)})</small>
        </div>`;
    });

    html += `<div class="summary-item">
        <strong>Total Volume:</strong> <span class="category-volume">${data.total_volume.toFixed(1)} L</span>
    </div>`;

    container.innerHTML = html;
}

function renderYearlySummary(data) {
    const container = document.getElementById('yearlySummary');
    let html = `<div class="summary-item">
        <strong>Year:</strong> ${data.year}
    </div>`;

    Object.entries(data.categories).forEach(([category, catData]) => {
        html += `<div class="summary-item">
            <span class="category-volume">${category}: ${catData.volume.toFixed(1)} L</span>
            <small class="text-muted">(₹${catData.amount.toFixed(2)})</small>
        </div>`;
    });

    html += `<div class="summary-item">
        <strong>Total Volume:</strong> <span class="category-volume">${data.total_volume.toFixed(1)} L</span>
    </div>`;

    container.innerHTML = html;
}

// Refresh functions
function refreshAllData() {
    loadSummaryData();
    loadTabData(currentTab);
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
