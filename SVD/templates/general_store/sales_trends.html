{% extends 'general_store/base.html' %}
{% load static %}

{% block title %}Sales Trends - General Store - SVD Agencies{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/general_store/sales_trends.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4 h-100">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-4 fw-bold text-primary mb-2">Sales Trends</h1>
                    <p class="lead text-muted mb-0">Analyze your sales performance with detailed insights</p>
                </div>
                <a href="{% url 'general_store:home' %}" class="btn btn-outline-primary">
                    <i class="bi bi-house-door me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <ul class="nav nav-tabs mb-3 mb-md-0" id="filterTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link {% if filter_type == 'today' %}active{% endif %}"
                           href="?filter=today{% if category_id %}&category={{ category_id }}{% endif %}" role="tab">
                            <i class="bi bi-calendar-day me-2"></i>Today
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link {% if filter_type == 'week' %}active{% endif %}"
                           href="?filter=week{% if category_id %}&category={{ category_id }}{% endif %}" role="tab">
                            <i class="bi bi-calendar-week me-2"></i>This Week
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link {% if filter_type == 'month' %}active{% endif %}"
                           href="?filter=month{% if category_id %}&category={{ category_id }}{% endif %}" role="tab">
                            <i class="bi bi-calendar-month me-2"></i>This Month
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link {% if filter_type == 'year' %}active{% endif %}"
                           href="?filter=year{% if category_id %}&category={{ category_id }}{% endif %}" role="tab">
                            <i class="bi bi-calendar-year me-2"></i>This Year
                        </a>
                    </li>
                </ul>

                <!-- Category Filter -->
                <div class="d-flex align-items-center">
                    <label for="categoryFilter" class="form-label me-2 mb-0 fw-semibold">
                        <i class="bi bi-funnel me-1"></i>Filter by Category:
                    </label>
                    <select class="form-select" id="categoryFilter" style="min-width: 200px;">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if category_id == category.id|stringformat:"s" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="row g-3 g-md-4 mb-5">
        <!-- Current Sales Card -->
        <div class="col-lg-3 col-md-6 col-12">
            <div class="card h-100 shadow-lg border-0 hover-lift">
                <div class="card-body text-center p-4 position-relative overflow-hidden">
                    <div class="position-absolute top-0 end-0 bg-primary opacity-10" style="width: 100px; height: 100px; border-radius: 50%; transform: translate(30px, -30px);"></div>
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-receipt-cutoff text-primary fs-2"></i>
                        </div>
                    </div>
                    <h2 class="card-title text-primary mb-2 fw-bold">{{ current_total_sales }}</h2>
                    <p class="card-text text-muted mb-2 fs-5">Current Period Sales</p>
                    <div class="metric-change {% if sales_change >= 0 %}positive{% else %}negative{% endif %}">
                        <i class="bi bi-arrow-{% if sales_change >= 0 %}up{% else %}down{% endif %} me-1"></i>
                        {{ sales_change|floatformat:1 }}% vs previous period
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Revenue Card -->
        <div class="col-lg-3 col-md-6 col-12">
            <div class="card h-100 shadow-lg border-0 hover-lift">
                <div class="card-body text-center p-4 position-relative overflow-hidden">
                    <div class="position-absolute top-0 end-0 bg-success opacity-10" style="width: 100px; height: 100px; border-radius: 50%; transform: translate(30px, -30px);"></div>
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-cash-stack text-success fs-2"></i>
                        </div>
                    </div>
                    <h2 class="card-title text-success mb-2 fw-bold">₹{{ current_total_revenue|floatformat:2 }}</h2>
                    <p class="card-text text-muted mb-2 fs-5">Current Period Revenue</p>
                    <div class="metric-change {% if revenue_change >= 0 %}positive{% else %}negative{% endif %}">
                        <i class="bi bi-arrow-{% if revenue_change >= 0 %}up{% else %}down{% endif %} me-1"></i>
                        {{ revenue_change|floatformat:1 }}% vs previous period
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Profit Card -->
        <div class="col-lg-3 col-md-6 col-12">
            <div class="card h-100 shadow-lg border-0 hover-lift">
                <div class="card-body text-center p-4 position-relative overflow-hidden">
                    <div class="position-absolute top-0 end-0 bg-warning opacity-10" style="width: 100px; height: 100px; border-radius: 50%; transform: translate(30px, -30px);"></div>
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-graph-up text-warning fs-2"></i>
                        </div>
                    </div>
                    <h2 class="card-title text-warning mb-2 fw-bold">₹{{ current_total_profit|floatformat:2 }}</h2>
                    <p class="card-text text-muted mb-2 fs-5">Current Period Profit</p>
                    <div class="metric-change {% if profit_change >= 0 %}positive{% else %}negative{% endif %}">
                        <i class="bi bi-arrow-{% if profit_change >= 0 %}up{% else %}down{% endif %} me-1"></i>
                        {{ profit_change|floatformat:1 }}% vs previous period
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Analytics Card -->
        <div class="col-lg-3 col-md-6 col-12">
            <div class="card h-100 shadow-lg border-0 hover-lift">
                <div class="card-body text-center p-4 position-relative overflow-hidden">
                    <div class="position-absolute top-0 end-0 bg-info opacity-10" style="width: 100px; height: 100px; border-radius: 50%; transform: translate(30px, -30px);"></div>
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-tags text-info fs-2"></i>
                        </div>
                    </div>
                    <h2 class="card-title text-info mb-2 fw-bold">{{ category_summary.total_categories }}</h2>
                    <p class="card-text text-muted mb-2 fs-5">Active Categories</p>
                    <div class="small text-muted">
                        <div class="mb-1"><strong>Top:</strong> {{ category_summary.top_category }}</div>
                        <div><strong>₹{{ category_summary.top_category_revenue|floatformat:0 }}</strong></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-5">
        <!-- Sales Trend Chart -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-info text-white d-flex align-items-center">
                    <i class="bi bi-graph-up me-2"></i>
                    <h5 class="mb-0">Sales Trends</h5>
                </div>
                <div class="card-body p-4">
                    <div class="chart-container">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Products Chart -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-success text-white d-flex align-items-center">
                    <i class="bi bi-bar-chart me-2"></i>
                    <h5 class="mb-0">Top Selling Products</h5>
                </div>
                <div class="card-body p-4">
                    <div class="chart-container">
                        <canvas id="topProductsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Analytics Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-info text-white d-flex align-items-center">
                    <i class="bi bi-tags me-2"></i>
                    <h5 class="mb-0">Category Performance Details</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <!-- Top Performing Category -->
                        <div class="col-lg-6 mb-4">
                            <div class="card border-success h-100">
                                <div class="card-header bg-success text-white">
                                    <i class="bi bi-trophy me-2"></i>Top Performing Category
                                </div>
                                <div class="card-body">
                                    <h4 class="card-title text-success">{{ category_summary.top_category }}</h4>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="fs-5 fw-bold text-primary">{{ top_category_sales }}</div>
                                            <small class="text-muted">Total Sales</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-5 fw-bold text-success">₹{{ category_summary.top_category_revenue|floatformat:0 }}</div>
                                            <small class="text-muted">Revenue</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-5 fw-bold text-warning">₹{{ top_category_profit|floatformat:0 }}</div>
                                            <small class="text-muted">Profit</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Performing Category -->
                        <div class="col-lg-6 mb-4">
                            <div class="card border-danger h-100">
                                <div class="card-header bg-danger text-white">
                                    <i class="bi bi-arrow-down-circle me-2"></i>Lowest Performing Category
                                </div>
                                <div class="card-body">
                                    <h4 class="card-title text-danger">{{ category_summary.bottom_category }}</h4>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="fs-5 fw-bold text-primary">{{ bottom_category_sales }}</div>
                                            <small class="text-muted">Total Sales</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-5 fw-bold text-success">₹{{ category_summary.bottom_category_revenue|floatformat:0 }}</div>
                                            <small class="text-muted">Revenue</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-5 fw-bold text-warning">₹{{ bottom_category_profit|floatformat:0 }}</div>
                                            <small class="text-muted">Profit</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Category Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Category</th>
                                    <th class="text-center">Total Sales</th>
                                    <th class="text-center">Quantity Sold</th>
                                    <th class="text-end">Revenue (₹)</th>
                                    <th class="text-end">Profit (₹)</th>
                                    <th class="text-center">Avg. Sale Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in category_analytics %}
                                <tr>
                                    <td class="fw-semibold">{{ category.product__category__name }}</td>
                                    <td class="text-center">{{ category.total_sales }}</td>
                                    <td class="text-center">{{ category.total_quantity }}</td>
                                    <td class="text-end">₹{{ category.total_revenue|floatformat:2 }}</td>
                                    <td class="text-end">₹{{ category.total_profit|floatformat:2 }}</td>
                                    <td class="text-center">₹{{ category.avg_sale_value|floatformat:2 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No category data available for the selected period</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Charts Row -->
    <div class="row mb-5">
        <!-- Revenue vs Profit Chart -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white d-flex align-items-center">
                    <i class="bi bi-bar-chart-line me-2"></i>
                    <h5 class="mb-0">Revenue vs Profit</h5>
                </div>
                <div class="card-body p-4">
                    <div class="chart-container">
                        <canvas id="revenueProfitChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profit Margin Chart -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-warning text-white d-flex align-items-center">
                    <i class="bi bi-percent me-2"></i>
                    <h5 class="mb-0">Profit Margin Trends</h5>
                </div>
                <div class="card-body p-4">
                    <div class="chart-container">
                        <canvas id="profitMarginChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/chart.js' %}"></script>
<script>
function updateDateTime() {
    const now = new Date();
    // No date/time display needed for trends page
}

document.addEventListener('DOMContentLoaded', function() {
    // Sales trend chart
    createSalesTrendChart(
        {{ labels|safe }},
        {{ sales_counts|safe }},
        {{ revenue_data|safe }},
        {{ profit_data|safe }}
    );

    // Top products chart
    createTopProductsChart(
        {{ product_labels|safe }},
        {{ product_quantities|safe }},
        {{ product_revenues|safe }}
    );

    // Revenue vs Profit chart
    createRevenueProfitChart(
        {{ labels|safe }},
        {{ revenue_data|safe }},
        {{ profit_data|safe }}
    );

    // Profit margin chart
    createProfitMarginChart(
        {{ labels|safe }},
        {{ profit_data|safe }},
        {{ revenue_data|safe }}
    );
});

// Function to create revenue vs profit chart
function createRevenueProfitChart(labels, revenueData, profitData) {
    const ctx = document.getElementById('revenueProfitChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Revenue (₹)',
                data: revenueData,
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1
            }, {
                label: 'Profit (₹)',
                data: profitData,
                backgroundColor: 'rgba(255, 99, 132, 0.8)',
                borderColor: 'rgb(255, 99, 132)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Revenue vs Profit Comparison'
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Period'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount (₹)'
                    }
                }
            }
        }
    });
}

// Category filter functionality
document.getElementById('categoryFilter').addEventListener('change', function() {
    const categoryId = this.value;
    const currentUrl = new URL(window.location);
    if (categoryId) {
        currentUrl.searchParams.set('category', categoryId);
    } else {
        currentUrl.searchParams.delete('category');
    }
    window.location.href = currentUrl.toString();
});
</script>
{% endblock %}
