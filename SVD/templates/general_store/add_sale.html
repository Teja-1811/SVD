{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Add Sale - General Store - SVD Agencies</title>
    <link rel="icon" href="{% static 'SVD.png' %}" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #0d1a3a">
      <div class="container-fluid">
        <a class="navbar-brand text-decoration-underline" href="{% url 'general_store:home' %}">
          <img src="{% static 'SVD.png' %}" alt="Logo" style="height: 80px; margin-right: 8px" />General Store
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" href="{% url 'general_store:product_list' %}"><i class="bi bi-box-seam"></i> Products</a></li>
            <li class="nav-item"><a class="nav-link active" href="{% url 'general_store:sales_list' %}"><i class="bi bi-receipt"></i> Sales</a></li>
          </ul>
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/milk_agency/"><i class="bi bi-cow"></i> Milk Agency</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'customer_portal:logout' %}"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h3>Add New Sale</h3>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="customer" class="form-label">Customer</label>
                                <select class="form-control" id="customer" name="customer" required>
                                    <option value="">Select Customer</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.name }} ({{ customer.phone }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div id="items">
                                <h5>Items</h5>
                                <div class="item-row mb-3 border p-3">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Product</label>
                                            <select class="form-control product-select" name="product" required>
                                                <option value="">Select Product</option>
                                                {% for product in products %}
                                                <option value="{{ product.id }}" data-price="{{ product.selling_price }}">{{ product.name }} (₹{{ product.selling_price }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Quantity</label>
                                            <input type="number" class="form-control quantity-input" name="quantity" min="1" required>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Discount</label>
                                            <input type="number" step="0.01" class="form-control discount-input" name="discount" value="0">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Total</label>
                                            <input type="number" step="0.01" class="form-control total-input" readonly>
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button type="button" class="btn btn-danger remove-item">Remove</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="add-item" class="btn btn-secondary mb-3">
                                <i class="bi bi-plus"></i> Add Item
                            </button>
                            <div class="mb-3">
                                <strong>Total Amount: ₹<span id="grand-total">0.00</span></strong>
                            </div>
                            <button type="submit" class="btn btn-success">Create Sale</button>
                            <a href="{% url 'general_store:sales_list' %}" class="btn btn-secondary">Cancel</a>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let itemIndex = 1;

        function updateTotal(row) {
            const productSelect = row.querySelector('.product-select');
            const quantityInput = row.querySelector('.quantity-input');
            const discountInput = row.querySelector('.discount-input');
            const totalInput = row.querySelector('.total-input');

            const price = parseFloat(productSelect.selectedOptions[0]?.dataset.price || 0);
            const quantity = parseInt(quantityInput.value || 0);
            const discount = parseFloat(discountInput.value || 0);

            const total = (price * quantity) - discount;
            totalInput.value = total.toFixed(2);
            updateGrandTotal();
        }

        function updateGrandTotal() {
            let grandTotal = 0;
            document.querySelectorAll('.total-input').forEach(input => {
                grandTotal += parseFloat(input.value || 0);
            });
            document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
        }

        document.getElementById('add-item').addEventListener('click', function() {
            const itemsDiv = document.getElementById('items');
            const newRow = document.querySelector('.item-row').cloneNode(true);
            newRow.querySelectorAll('input').forEach(input => input.value = '');
            newRow.querySelector('.product-select').value = '';
            itemsDiv.appendChild(newRow);
            itemIndex++;
        });

        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('product-select') || e.target.classList.contains('quantity-input') || e.target.classList.contains('discount-input')) {
                updateTotal(e.target.closest('.item-row'));
            }
        });

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-item')) {
                if (document.querySelectorAll('.item-row').length > 1) {
                    e.target.closest('.item-row').remove();
                    updateGrandTotal();
                }
            }
        });
    </script>
</body>
</html>
